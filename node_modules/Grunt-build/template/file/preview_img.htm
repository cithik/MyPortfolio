<!doctype html>
<html lang="en">
<head>
    <title>上传图片</title>
    <meta charset="UTF-8" />
    <style type="text/css">
        html, body, form, div, p {margin:0;padding:0;}
        body {font:12px/1.5 "Microsoft Yahei";}
        .preview {margin-top:3px;}
        .gray {color:#a9a9a9; width: 300px; margin-bottom: 10px;}
        .cf {zoom:1;}
        .cf:after {clear:both;display:table;content:"";}
        .fl {float:left;}
        .pr {width:64px;text-align:center;margin-right:10px;position:relative;}
        .pr img {width:64px;height:64px;}
        a {text-decoration:none;color:#7f7c77;outline:none;}
        a:hover {text-decoration:underline;}
        a img {border:none;}
        a, button ,input { cursor: pointer; }
        input {outline:none;}
        .file {width:210px; height: 38px; line-height: 38px; opacity: 0; opacity: 1\9; position: absolute;  left: 0;  top:0; z-index: 10;  }
        .loading .cover {top:0;left:0;width:100%;position:absolute;height:100%;opacity:0.6;z-index:1;background:#fff url(/static/images/ajax-loader.gif) no-repeat center center;filter:alpha(opacity=60);_height:85px;}
        .form { position: relative; width: 296px; height: 38px;}
        .select-tips
        {
            display: inline-block;
            display: none\9;
            width: 200px;
            height: 26px;
            padding: 4px 5px;
            line-height: 26px;
            border: 1px solid rgb(217, 217, 217);
            border-radius: 2px;
            background-color: rgb(255, 255, 255);
            box-shadow: 0 0 3px rgb(221, 221, 221) inset;
            position: absolute;
            left: 0;
            top:0;
            z-index: 1;
            color: #9c9c9c;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }
        .upload {
            display: inline-block;
            position: absolute;
            width: 78px;
            height: 38px;
            right: 0;
            top:0;
            z-index: 10;
            opacity: 0;
            filter:alpha(opacity=0);
        }
        .upload-tips {
            display: inline-block;
            width: 63px;
            height: 28px;
            padding: 4px 5px;
            line-height: 28px;
            background: url(http://img1.37wanimg.com/kf2016/images/common/upload.png) no-repeat;
            background-size: 100% 100%;;
            box-shadow: 0 0 3px rgb(221, 221, 221) inset;
            position: absolute;
            right: 0;
            top:0;
            z-index: 1;
            color: #3c3c3c;
            text-align: center;
        }
    </style>
</head>

<body>

<form id="form" action="" method="post" enctype="multipart/form-data" name="form1" id="form1" class="form">
    <input class="file" name="img" type="file" id="img"  />
    <a class="select-tips" href="javascript:;">请选择本地文件...</a>
    <input class="upload" type="submit" id="select-img" value="上传">
    <a class="upload-tips" href="javascript:;">上传</a>
</form>

<div id="pr" class="preview cf">
    <p class="gray">先选择jpg/jpeg/png/gif格式的图片，然后点击“上传”按钮。最多可以传五张图片，总大小不超过 2 M。</p>
    {{foreach from=$arr_tmp_imgs item=img key=key }}
    <div class="pr fl">
        <a title="点击查看大图" href="/index.php?c=file&a=view_img&file={{$img}}" target="_blank" file="{{$img}}">
            <img data-src="/index.php?c=file&a=read&file={{$img}}" width="64" height="64">
        </a>
        <a class="del" href="/index.php?c=file&a=unfile&t={{$s.t}}&file={{$img}}&i={{$key}}" target="_blank">删除</a>
        <div class="cover"></div>
    </div>
    {{/foreach}}
</div>

<script type="text/javascript" src="http://ptres.37.com/js/sq/lib/sq.core.js"></script>
<script type="text/javascript">
    $("#img").on("change",function(){
        var tips =$(this).val() ? $(this).val(): "请选择本地文件...";
        $(".select-tips").html(tips);
    });

    var $p = $( "#pr" ).on( "click", "a.del", function( e ) {
        e.preventDefault();
        var $this = $( this ),
                $pr = $this.closest( ".pr" ).addClass( "loading" );
        $.getJSON( $this.attr("href") )
                .done(function( res ) {
                    if ( res.status == "1" ) {
                        $pr.remove();

                        var len = parent.window.imgCount = $p.find( ".pr" ).length;
                        if ( !len ) {
                            $p.html(
                                    '<p class="gray">先选择jpg/jpeg/png/gif格式的图片，然后点击“上传”按钮。最多可以传五张图片，总大小不超过 2 M。</p>'
                            );
                        }

                    } else {
                        $pr.removeClass( "loading" );
                        parent.SQ.alert( "删除失败" );
                    }
                });
    });


    $( "#form" ).on( "submit", function( e ) {
        if ( this.elements.img.value === "" ) {
            e.preventDefault();
            return parent.SQ.alert( "先选一张图片^o^" );
        }
        if ( !/(\.gif|\.jp(e)?g|\.png)$/i.test(this.img.value)  ) {
            e.preventDefault();
            return parent.SQ.alert( "请选择格式为jpg/jpeg/png/gif的图片^o^" );
        }
        if ( $p.find("img").length >= 5 ) {
            e.preventDefault();
            return parent.SQ.alert( "最多五张图片哦^o^" );
        }

        parent.$( "#upload-wrap" ).addClass( "upload-loading" );
    });


    var count = 0,
        len = $p.find( "img" )
            // 先绑定 load 在赋值 src ，否则 ie 里面监听不到 load 事件
            .on( "load", function() {
                count++;
                if ( count === len ) {
                    parent.$( "#upload-wrap" ).removeClass( "upload-loading" );
                }
            }).each(function() {
                $( this ).prop( "src", this.getAttribute("data-src") )
            }).length;

    if ( len == 0 ){
        parent.$ && parent.$( "#upload-wrap" ).removeClass( "upload-loading" );
    }
    parent.imgCount = len || 0;
    setTimeout(function(){
        if( parent.imgCount !== 0 ){
            parent.$ && parent.$( ".service-form-tr-upload").height("200px");
            parent.$ && parent.$( ".service-form-tr-upload iframe").height("200px");
        }else{
            parent.$ && parent.$( ".service-form-tr-upload").height("95px");
            parent.$ && parent.$( ".service-form-tr-upload iframe").height("95px");
        }
    },200);
</script>

</body>
</html>
