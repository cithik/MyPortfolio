/**
 * Author: denghuafeng
 * Date: 2016/5/25
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js"
],function(common,modulesCommon){

    var ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var main = {

        init: function() {
            this.getDom();
            this.event();
        },
        domainUrl: "http://kf.37.com",
        vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
        stepSubmitUrlOne: "/index.php?c=stolen&a=actSupplyInfoFirst",//第一次补充资料
        stepSubmitUrlTwo: "/index.php?c=stolen&a=actSupplyInfoSecond",//第二次补充资料
        stepSubmitUrlThree: "/index.php?c=stolen&a=actSecondAdd",//丢失物品资料
        submitUrl:"",
        dataArrOne:{
            id:"",//工单号
            register_phone:"",//密保手机
            register_email: "",//密保邮箱
            register_id_card_number:"",//身份证
            recharge_record:""//充值记录
        },
        dataArrTwo:{
            id:"",//工单号
            goods_name: "",//丢失物品名称
            account_remark:""//详细描述
        },
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$sResult = $(".s-result");
            _this.$btnStepSupply = _this.$sResult.find(".btn-step-supply");
            _this.$formResult = _this.$sResult.find("#service-form-result");
            _this.$orderListSupply = _this.$sResult.find(".order-list-supply");
            _this.$supplyOne = _this.$sResult.find(".supply-one");
            _this.$supplyTwo = _this.$sResult.find(".supply-two");
            _this.$serviceBar = _this.$sResult.find(".service-bar-1");
            _this.$formOne = _this.$sResult.find("#service-form-edit-one");
            _this.$formTwo = _this.$sResult.find("#service-form-edit-two");
            _this.$formThree = _this.$sResult.find("#service-form-edit-three");
            _this.$formResultOne = _this.$sResult.find("#service-form-result-one");
            _this.$formResultTwo = _this.$sResult.find("#service-form-result-two");
        },
        /*绑定事件*/
        event: function(){
            var _this = this,
            /*表单验证*/
                v = new SQ.Validate( {
                    form: _this.$sResult,
                    successView: true
                } );

            _this.$sResult
                /*补充个人信息按钮*/
                .on("click",".btn-step-supply-one",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    modulesUtil.scrollToTop(229);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    $this.addClass("pending");
                    _this.submitUrl = ( $this.data("url") != "1" ) ? _this.stepSubmitUrlOne :_this.stepSubmitUrlTwo;
                    _this.$supplyTwo.hide();
                    _this.$formResultTwo.hide();
                    _this.$supplyOne.show();
                })
                /*补充个人信息按钮*/
                .on("click",".btn-step-supply-two",function(e){
                    e.preventDefault();
                    modulesUtil.scrollToTop(229);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    $(this).addClass("pending");
                    _this.$supplyOne.hide();
                    _this.$formResultOne.hide();
                    _this.$supplyTwo.show();
                })
                .on("click",".btn-step-next",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    _this.$id = $( "#bill_number" );
                    _this.$registerPhone = $( "#register_phone" );
                    _this.$registerEmail = $( "#register_email" );
                    _this.$registerIdCardNumber = $( "#register_id_card_number" );


                    if ( _this.$registerPhone.length > 0 && !v.checkField( _this.$registerPhone ) ) {
                        return SQ.alert( _this.$registerPhone.data( "message" ) );
                    }
                    if ( _this.$registerEmail.length > 0 && !v.checkField( _this.$registerEmail ) ) {
                        return SQ.alert( _this.$registerEmail.data( "message" ) );
                    }
                    if ( _this.$registerIdCardNumber.length > 0 && !v.checkField( _this.$registerIdCardNumber ) ) {
                        return SQ.alert( _this.$registerIdCardNumber.data( "message" ) );
                    }
                    //判断帐号充值
                    if( modulesUtil.rechargeRecordCheck() ){
                        return false;
                    }
                    //获取帐号充值记录
                    _this.dataArrOne.recharge_record = modulesUtil.rechargeRecordArr();

                    _this.dataArrOne.id = _this.$id.val();
                    _this.dataArrOne.register_phone = _this.$registerPhone.val();
                    _this.dataArrOne.register_email = _this.$registerEmail.val();
                    _this.dataArrOne.register_id_card_number = _this.$registerIdCardNumber.val();


                    /*进度条操作*/
                    _this.$serviceBar.addClass("width-215");
                    $(".sb-2").addClass("on");
                    /*表单显示操作*/
                    _this.$formOne.hide();
                    _this.$formTwo.show();
                    modulesUtil.scrollToTop(229);

                    window.frames["card-iframe"] && window.frames["card-iframe"].window.$("html").css({"background-color":"#d9ecff"});
                })
                /*点击StepOne*/
                .on("click",".btn-step-submit-one",function(e){
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if( parent.imgCount === 0 ) {
                        return SQ.alert("请上传身份证原件扫描件");
                    }
                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, modulesUtil.aj, {
                        url: _this.domainUrl + _this.submitUrl,
                        data: _this.dataArrOne,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {

                                _this.$serviceBar.addClass("width-294");
                                $(".sb-3").addClass("on");
                                /*表单显示操作*/
                                _this.$formTwo.hide();
                                _this.$formResultOne.show();
                                modulesUtil.scrollToTop(229);

                                $(".btn-step-supply-one")
                                    .removeClass("btn-step-supply-one")
                                    .addClass("btn-step-supply")
                                    .html("已补充提交资料")
                                    .css({
                                        background: "#a5a5a5",
                                        width:"auto",
                                        padding: "0 10px"
                                    })
                                ;
                            } else {
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );


                })
                /*点击StepTwo*/
                .on("click",".btn-step-submit-two",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;

                    _this.$id = $( "#bill_number" );
                    _this.$goodsName = $( "#goods_name" );
                    _this.$accountRemark = $( "#account_remark" );


                    if ( _this.$goodsName.length > 0 && !v.checkField( _this.$goodsName ) ) {
                        return SQ.alert( _this.$goodsName.data( "message" ) );
                    }
                    if ( _this.$accountRemark.length > 0 && !v.checkField( _this.$accountRemark ) ) {
                        return SQ.alert( _this.$accountRemark.data( "message" ) );
                    }

                    _this.dataArrTwo.id = _this.$id.val();
                    _this.dataArrTwo.goods_name = _this.$goodsName.val();
                    _this.dataArrTwo.account_remark = _this.$accountRemark.val();


                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, modulesUtil.aj, {
                        url: _this.domainUrl + _this.stepSubmitUrlThree,
                        data: _this.dataArrTwo,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {
                                _this.$formThree.hide();
                                _this.$formResultTwo.show();
                                modulesUtil.scrollToTop(229);

                                $(".btn-step-supply-two")
                                    .removeClass("btn-step-supply-two")
                                    .addClass("btn-step-supply")
                                    .html("已补充提交资料")
                                    .css({
                                        background: "#a5a5a5",
                                        width:"auto",
                                        padding: "0 10px"
                                    })
                                ;
                            } else {
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );

                })
                /*充值记录增加*/
                .on("click",".service-recharge-add",function(){
                    modulesUtil.rechargeRecordInit( 15 );
                })
                /*充值记录减少*/
                .on("click",".recharge-del",function(){
                    var $this = $(this);
                    modulesUtil.rechargeRecordDel( $this );
                });
        }

    };
    return {
        init:function(){
            main.init();
        }
    };
});
