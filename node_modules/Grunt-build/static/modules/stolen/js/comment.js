/**
 * Author: denghuafeng
 * Date: 2016/5/25
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common"
],function(common,modulesCommon){

    var ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var main = {

        init: function() {
            this.getDom();
            this.event();
            this.rateGenerator();
        },
        domainUrl: "http://kf.37.com",
        vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
        stepSubmitUrl: "/index.php?c=stolen&a=actComment",//评论
        dataArr:{
            id:"",//工单号
            gm_valuate: "",//总体感觉
            time_length_valuate:"",//处理时长
            gm_attitude_valuate:"",//服务态度
            result_valuate: "",//服务结果
            is_solve:"",//是否解决您的问题
            recommend_degree:"",//推荐我们的产品
            suggestion: ""//建议
        },
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$sComment = $(".s-comment");
            _this.$btnStepSupply = _this.$sComment.find(".btn-step-supply");
            _this.$formResult = _this.$sComment.find("#service-form-result");
            _this.$orderListSupply = _this.$sComment.find(".order-list-supply");
        },
        /*绑定事件*/
        event: function(){
            var _this = this;
            _this.$sComment
                /*点击StepOne*/
                .on("click",".btn-step-submit",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$id ) {
                        _this.$id = $( "#bill_number" );
                        _this.$gmValuate = $( ".gm_valuate" );
                        _this.$timeLengthValuate = $( ".time_length_valuate" );
                        _this.$gmAttitudeValuate = $( ".gm_attitude_valuate" );
                        _this.$resultValuate = $( ".result_valuate" );
                        _this.$isSolve = $( ".is_solve" );
                        _this.$recommendDegree = $( ".recommend_degree" );
                        _this.$suggestion = $( "#suggestion" );
                    }


                    _this.dataArr.id = _this.$id.val();
                    _this.dataArr.gm_valuate = _this.$gmValuate.children(".activeStar").length ;
                    _this.dataArr.time_length_valuate = _this.$timeLengthValuate.children(".activeStar").length ;
                    _this.dataArr.gm_attitude_valuate = _this.$gmAttitudeValuate.children(".activeStar").length ;
                    _this.dataArr.result_valuate = _this.$resultValuate.children(".activeStar").length ;
                    _this.dataArr.is_solve = _this.$isSolve.children(".activeStar").length;
                    _this.dataArr.recommend_degree = $("input[name='isRecommend']:checked").val() ;
                    _this.dataArr.suggestion = _this.$suggestion.val() ;

                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, modulesUtil.aj, {
                        url: _this.domainUrl + _this.stepSubmitUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {
                                SQ.alert( res.msg ,function(){
                                    location.reload();
                                });
                            } else {
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );


                })
        },
        /**
         * 星级评分逻辑处理,修改函数前面的初始值
         * @class rateGenerator
         */
        rateGenerator: function() {
            //提示数组
            var tips = ["1分 非常不满意", "2分 非常不满意", "3分 不满意", "4分 不满意", "5分 一般", "6分 一般", "7分 满意", "8分 满意", "9分 非常满意", "10分 非常满意"],
                //每组的星星个数
                starNum = 10,
                //每组颜色
                fontColor = ["#6c6c6c", "#9c9c9c", "#78c31f", "#ffb413", "#f25277"],
                //提示的背景颜色
                tipColor = ["#f2f2f2", "#f2f2f2", "#f2fde4", "#fff6e9", "#ffdde5"],
                //正常的星星字体
                normalFont = "&#xe600;",
                //激活时的星星字体
                activeFont = "&#xe604;",
                //激活时的类
                activeClass = 'activeStar',
                initHtml = "",
                //获取所有需要添加星级评分的元素
                $starRate = $('.starRate'),

                _this = this;


            //循环遍历初始化html
            for(var i=0; i<starNum; i++) {
                initHtml += (i <5 ) ? '<span class="iconfont activeStar">'+activeFont+'</span>' : '<span class="iconfont">'+normalFont+'</span>';
            }
            //提示条
            var tipHtml = '<span class="tip"><span class="tip-before"></span><span class="tip-text">5分 一般</span><span class="tip-after"></span></span>';

            //初始化页面的starRate,并赋值不同颜色
            $starRate.html(initHtml).after(tipHtml);
            for(var i=0, length=$starRate.length; i<length; i++) {
                //更换字体颜色
                var $star = $starRate.eq(i);
                $star.children('.iconfont').css({'color': fontColor[i]});
                //更换tip背景颜色和边框颜色
                $star.next().css(
                    {'background': tipColor[i],
                    'borderColor': fontColor[i],
                    'color': fontColor[i]});
                $star.next().children('.tip-before').css({'borderColor': 'transparent '+fontColor[i]+' transparent transparent'});
                $star.next().children('.tip-after').css({'borderColor': 'transparent '+tipColor[i]+' transparent transparent'});
            }

            if( $("#gm_valuate").length > 0 ) {
                initStart( ".gm_valuate" , "#gm_valuate" );
                initStart( ".time_length_valuate" , "#time_length_valuate" );
                initStart( ".gm_attitude_valuate" , "#gm_attitude_valuate" );
                initStart( ".result_valuate" , "#result_valuate" );
                initStart( ".is_solve" , "#is_solve" );
            }

            function initStart ( eClass , eId ){
                var spanIndex = parseInt( $(eId).val());
                if( spanIndex === 10 ){
                    $(eClass).children("span").addClass(activeClass).html(activeFont);
                }else{
                    $(eClass).children("span").removeClass(activeClass).html(normalFont).eq(spanIndex).prevAll().addClass(activeClass).html(activeFont);
                }
                if( spanIndex === 0 ) {
                    $(eClass).next().children('.tip-text').text("0分 非常不满意");
                }else{
                    $(eClass).next().children('.tip-text').text(tips[spanIndex-1]);
                }

                $(eClass).children("span").addClass("pending");
            }
            //为星星添加点击事件
            _this.$sComment
                .on('click', ".starRate .iconfont", function() {
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    //假如点击的星星没有激活,则将它和它的前面子兄弟全部激活
                    var $this = $(this);
                    //获取其在兄弟元素中的序号
                    var index = $this.index();
                    if((!$this.hasClass(activeClass)) || (($this.hasClass(activeClass)) && ($this.next().hasClass(activeClass)))) {
                        $this.removeClass(activeClass).addClass(activeClass).html(activeFont).siblings().removeClass(activeClass).html(normalFont);
                        $this.prevAll().addClass(activeClass).html(activeFont);
                        $this.parent().next().show().children('.tip-text').text(tips[index]);

                    }
                    /*武筠霏强烈要求不增加此双击事件并丢雷楼某*/
                    //else if(($this.hasClass(activeClass)) && (!$this.next().hasClass(activeClass))) {
                    //    $this.removeClass(activeClass).html(normalFont).siblings().removeClass(activeClass).html(normalFont);
                    //    $this.parent().next().children('.tip-text').text("0分 非常不满意");
                    //}

                });
        }



    };
    return {
        init:function(){
            main.init();
        }
    };
});
