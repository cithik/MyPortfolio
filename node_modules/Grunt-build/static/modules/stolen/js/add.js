/**
 * Author: denghuafeng
 * Date: 2016/5/19
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/plugin/jquery.ui.position.js",
    "http://ptres.37.com/js/sq/widget/sq.selectmenu.js",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js",
    "http://ptres.37.com/js/kf2016/lib/laydate/laydate.js"
],function(common,modulesCommon){

    var cUser = common.user,
        ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var main = {

        init: function() {
            this.getDom();
            this.event();
            this.selectInit();
            this.leftMenuInit();
            this.formInit();
        },
        domainUrl: "http://kf.37.com",
        vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
        verphoneCodeUrl: "/index.php?c=recover_avatar&a=sendPhoneCode",//发送手机验证码
        stepTwoUrl: "/index.php?c=stolen&a=actAdd",//数据提交
        dataArr: {
            real_name:"",//真实姓名
            phone: "",//联系手机
            game_account_people_count:"",//帐号使用人数
            game: "",//游戏
            server:"",//服务器
            avatar:"",//角色名
            often_login_address_1:"",//常登陆地址1
            often_login_address_2: "",//常登陆地址2
            app_bind: "",//是否绑定37安全令牌
            goods_lose_time:"",//丢失日期
            goods_lose_reason:"",//丢失原因
            goods_name:"",//物品丢失名称
            content: "",//详细描述
            aucode: "",//验证码
            is_agreement:""//被盗申诉协议
        },
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$sAdd = $(".s-add");
            _this.$serviceBar = _this.$sAdd.find(".service-bar-1");
            _this.$serviceFromVercode = _this.$sAdd.find(".service-form-vercode");
            _this.$formOne = _this.$sAdd.find("#service-form-edit-one");
            _this.$formTwo = _this.$sAdd.find("#service-form-edit-two");
            _this.$formResult = _this.$sAdd.find("#service-form-result");
        },
        //左侧栏选中事件
        leftMenuInit: function(){
            $("#side-stolen").addClass("focus");
        },
        /*渲染select表单*/
        selectInit: function(){

            var s1 = new SQ.Selectmenu( {
                element: "#province1",
                width: 146,
                height: 300
            } );


            var s2 = new SQ.Selectmenu( {
                element: "#city1",
                width: 146,
                height: 300
            } );

            modulesUtil.selectCity(s1,s2,$("#city1"));

            var s3 = new SQ.Selectmenu( {
                element: "#province2",
                width: 146,
                height: 300
            } );

            var s4 = new SQ.Selectmenu( {
                element: "#city2",
                width: 146,
                height: 300
            } );

            modulesUtil.selectCity(s3,s4,$("#city2"));

            var s5 = new SQ.Selectmenu( {
                element: "#goods_lose_reason",
                width: 296,
                height: 300
            } );


        },
        /*表单初始化设置*/
        formInit:function(){
            //选择游戏
            modulesUtil.dropdown($("#select_game"));
            /*渲染帐号和VIP等级*/
            cUser.bindSuccess( function() {
                $("#game_account").html(cUser.userName);
                $("#vip_level").html("VIP"+cUser.info.VIP_DEEP);
            } );
            /*验证码初始化*/
            modulesUtil.varCodeInit();
        },
        /*绑定事件*/
        event: function(){
            var _this = this,
            /*表单验证*/
                v = new SQ.Validate( {
                    form: _this.$sAdd,
                    successView: true
                } );

            _this.$sAdd
                ///*刷新验证码*/
                //.on("click",".service-form-vercode",function(){
                //    $(this).children().attr("src",_this.vercodeUrl+"&t="+(new Date()).getTime());
                //})
                /*点击StepOne*/
                .on("click",".btn-step-one",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$realName ) {
                        _this.$realName   = $("#real_name");
                        _this.$phone = $("#phone");
                        _this.$gameAccount = $("#game_account");
                        _this.$gameAccountPeopleCount = $("#game_account_people_count");
                        _this.$game   = $("#game");
                        _this.$server = $("#server");
                        _this.$avatar = $("#avatar");
                        _this.$oftenLoginAddress1   = $("#often_login_address_1");
                        _this.$oftenLoginAddress2 = $("#often_login_address_2");
                        _this.$appBind = $("#app_bind");

                        _this.$province1   = $("#province1");
                        _this.$city1   = $("#city1");
                        _this.$province2   = $("#province2");
                        _this.$city2   = $("#city2");


                    }

                    /*判断是否填写必填项*/
                    if ( _this.$realName.length > 0 && !v.checkField( _this.$realName ) ) {
                        return SQ.alert( _this.$realName.data( "message" ) );
                    }
                    if ( _this.$phone.length > 0 && !v.checkField( _this.$phone ) ) {
                        return SQ.alert( _this.$phone.data( "message" ) );
                    }
                    if ( _this.$gameAccount.length > 0 && !v.checkField( _this.$gameAccount ) ) {
                        return SQ.alert( _this.$gameAccount.data( "message" ) );
                    }
                    //if ( !$("input[name='game_account_people_count']:checked").length  ) {
                    //    return SQ.alert( "请选择帐号使用人数~" );
                    //}

                    if ( _this.$game.length > 0 && !v.checkField( _this.$game ) ) {
                        return SQ.alert( _this.$game.data( "message" ) );
                    }
                    if ( _this.$server.length > 0 && !v.checkField( _this.$server ) ) {
                        return SQ.alert( _this.$server.data( "message" ) );
                    }
                    if ( _this.$avatar.length > 0 && !v.checkField( _this.$avatar ) ) {
                        return SQ.alert( _this.$avatar.data( "message" ) );
                    }

                    //判断地址
                    if ( !(_this.$province1.val() > 0) || !(_this.$city1.val() > 0) ) {
                        return SQ.alert( "请选择完整帐号常用登录地点1信息~" );
                    }

                    //判断是否绑定37安全令牌
                    if ( !$("input[name='app_bind']:checked").length  ) {
                        return SQ.alert( "请选择是否绑定37令牌~" );
                    }
                    /*获取数据*/
                    _this.dataArr.real_name = _this.$realName.val();
                    _this.dataArr.phone=_this.$phone.val();
                    _this.dataArr.game_account_people_count = $("input[name='game_account_people_count']:checked").val();

                    _this.dataArr.game = _this.$game.val();
                    _this.dataArr.server=_this.$server.val();
                    _this.dataArr.avatar=_this.$avatar.val();

                    _this.dataArr.often_login_address_1 = _this.$province1.children("option:checked").html() +"-"+ _this.$city1.children("option:checked").html();//常登陆地点1
                    _this.dataArr.often_login_address_2 = ( _this.$city2.val() > 0 ) ? _this.$province2.children("option:checked").html() +"-"+ _this.$city2.children("option:checked").html() : "";//常登陆地点2
                    _this.dataArr.app_bind = $("input[name='app_bind']:checked").val();

                    /*进度条操作*/
                    _this.$serviceBar.addClass("width-215");
                    $(".sb-2").addClass("on");
                    /*表单显示操作*/
                    _this.$formOne.hide();
                    _this.$formTwo.show();
                    modulesUtil.scrollToTop(229);
                })

                /*点击StepTwo*/
                .on("click",".btn-step-two",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;

                    if ( !_this.$goodsLoseTime ) {
                        _this.$goodsLoseTime   = $("#goods_lose_time");
                        _this.$goodsLoseReason = $("#goods_lose_reason");
                        _this.$goodsName = $("#goods_name");
                        _this.$content = $("#content");
                        _this.$aucode   = $("#aucode");
                        _this.$isAgreement = $("#is_agreement");

                    }

                    /*判断是否填写必填项*/
                    if ( _this.$goodsLoseTime.length > 0 && ( ( _this.$goodsLoseTime[0].value == "请选择您的物品丢失日期" ) || !_this.$goodsLoseTime[0].value ) ) {
                        return SQ.alert( _this.$goodsLoseTime.data( "message" ) );
                    }
                    if ( _this.$goodsLoseReason.length > 0 && !(_this.$goodsLoseReason.val()>0) ) {
                        return SQ.alert( _this.$goodsLoseReason.data( "message" ) );
                    }
                    if ( _this.$goodsName.length > 0 && !v.checkField( _this.$goodsName ) ) {
                        return SQ.alert( _this.$goodsName.data( "message" ) );
                    }

                    if ( _this.$content.length > 0 && !v.checkField( _this.$content ) ) {
                        return SQ.alert( _this.$content.data( "message" ) );
                    }
                    //if ( _this.$aucode.length > 0 && !v.checkField( _this.$aucode ) ) {
                    //    return SQ.alert( _this.$aucode.data( "message" ) );
                    //}
                    if ( !modulesUtil.varCodeInitCheck() ) return false;

                    if($("input[name='bind']:checked").length == 0 ){
                        return SQ.alert( "请认真阅读并同意被盗申诉协议~" );
                    }

                    /*获取数据*/
                    _this.dataArr.goods_lose_time = _this.$goodsLoseTime[0].value ;
                    _this.dataArr.goods_lose_reason =_this.$goodsLoseReason.val();
                    _this.dataArr.goods_name = _this.$goodsName.val();

                    _this.dataArr.content = _this.$content.val();
                    _this.dataArr.aucode=_this.$aucode.val();
                    _this.dataArr.is_agreement= 1;

                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, modulesUtil.aj, {
                        url: _this.domainUrl + _this.stepTwoUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {

                                /*进度条操作*/
                                _this.$serviceBar.addClass("width-294");
                                $(".sb-3").addClass("on");
                                /*表单显示操作*/
                                _this.$formTwo.hide();
                                _this.$formResult.show();
                                modulesUtil.scrollToTop(229);

                            } else {
                                modulesUtil.varCodeRefresh();
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );

                })
                /*新增帐号常用登录地*/
                .on("click",".account-address-add",function(){
                    $(this)
                        .hide()
                        .parents(".service-form-tr").removeClass("service-form-tr-add");
                    $(".account-address-2").show();
                })
                /*点击被盗申诉协议*/
                .on("click",".is-agreement",function(){
                    var $this = $(this);
                    if( $("input[name='bind']:checked").length ){
                        $this.children("span").addClass("on")
                    }else{
                        $this.children("span").removeClass("on")
                    }
                })
                .on("click",".btn-return-one",function(){
                    /*进度条操作*/
                    _this.$serviceBar.removeClass("width-215");
                    $(".sb-2").removeClass("on");
                    /*表单显示操作*/
                    _this.$formOne.show();
                    _this.$formTwo.hide();
                    modulesUtil.scrollToTop(229);
                })
                .on("click","#select_game", function(){
                    $(this).siblings("span").text("");
                })
        }

    };
    return {
        init:function(){
            main.init();
        }
    };
});


