/**
 * Author: denghuafeng
 * Date: 2016/5/23
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js"
],function(common,modulesCommon){

    var ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var main = {

        init: function() {
            this.getDom();
            this.event();
        },
        domainUrl: "http://kf.37.com",
        vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
        stepSubmitUrl: "/index.php?c=complaint&a=actAddUserInfo",//第一步提交
        dataArr:{
            id:"",//工单号
            phone: "",//游戏
            player_name:""//服务器
        },
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$serviceMain = $(".service-main");
            _this.$btnStepSupply = _this.$serviceMain.find(".btn-step-supply");
            _this.$formResult = _this.$serviceMain.find("#service-form-result");
            _this.$orderListSupply = _this.$serviceMain.find(".order-list-supply");
        },
        /*绑定事件*/
        event: function(){
            var _this = this,
            /*表单验证*/
                v = new SQ.Validate( {
                    form: _this.$serviceMain,
                    successView: true
                } );

            _this.$serviceMain
                /*补充个人信息按钮*/
                .on("click",".btn-step-supply",function(e){
                    e.preventDefault();
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    $(this).addClass("pending");
                    _this.$orderListSupply.show();
                    modulesUtil.scrollToTop(229);
                })
                /*点击StepOne*/
                .on("click",".btn-step-submit",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$id ) {
                        _this.$id = $( "#id" );
                        _this.$phone = $( "#phone" );
                        _this.$playerName = $( "#player_name" );
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$phone.length > 0 && !v.checkField( _this.$phone ) ) {
                        return SQ.alert( _this.$phone.data( "message" ) );
                    }
                    if ( _this.$playerName.length > 0 && !v.checkField( _this.$playerName ) ) {
                        return SQ.alert( _this.$playerName.data( "message" ) );
                    }


                    _this.dataArr.id = $(".order-number").html();
                    _this.dataArr.phone = _this.$phone.val();
                    _this.dataArr.player_name = _this.$playerName.val();

                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, modulesUtil.aj, {
                        url: _this.domainUrl + _this.stepSubmitUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {
                                SQ.alert( res.msg ,function(){
                                    location.reload();
                                });
                            } else {
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );


                });
        }

    };
    return {
        init:function(){
            main.init();
        }
    };
});

