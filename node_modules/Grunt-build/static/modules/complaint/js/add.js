/**
 * Author: denghuafeng
 * Date: 2016/5/18
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/plugin/jquery.ui.position.js",
    "http://ptres.37.com/js/sq/widget/sq.selectmenu.js",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js"
],function(common,modulesCommon){
    var cUser = common.user,
        ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var main = {

        init: function() {
            this.getDom();
            this.event();
            this.formInit();
        },
        domainUrl: "http://kf.37.com",
        vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
        stepOneUrl: "/index.php?c=complaint&a=actAdd",//第一步提交
        dataArr:{
            game: "",//游戏
            server:"",//服务器
            avatar:"",//角色名
            content:"",//内容
            aucode: ""//验证码
        },
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$cAdd = $(".c-add");
            _this.$serviceFromVercode = _this.$cAdd.find(".service-form-vercode");
            _this.$formOne = _this.$cAdd.find("#service-form-edit");
            _this.$formResult = _this.$cAdd.find("#service-form-result");
            _this.$formResultVip = _this.$cAdd.find("#service-form-result-vip");
        },
        /*表单初始化设置*/
        formInit:function(){
            //选择游戏
            modulesUtil.dropdown( $("#select_game") );
            /*渲染帐号和VIP等级*/
            cUser.bindSuccess( function() {
                $(".service-form-account").html(cUser.userName);
            } );
            /*验证码初始化*/
            modulesUtil.varCodeInit();
        },
        /*绑定事件*/
        event: function(){
            var _this = this,
            /*表单验证*/
            v = new SQ.Validate( {
                form: _this.$cAdd,
                successView: true
            } );

            _this.$cAdd
                /*刷新验证码*/
                .on("click",".service-form-vercode",function(){
                    $(this).children().attr("src",_this.vercodeUrl+"&t="+(new Date()).getTime());
                })
                /*点击StepOne*/
                .on("click",".btn-step-one",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$game ) {
                        _this.$game = $( "#game" );
                        _this.$server = $( "#server" );
                        _this.$avatar = $( "#avatar" );
                        _this.$content = $( "#content" );
                        _this.$aucode = $( "#aucode" );
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$game.length > 0 && !v.checkField( _this.$game ) ) {
                        return SQ.alert( _this.$game.data( "message" ) );
                    }
                    if ( _this.$server.length > 0 && !v.checkField( _this.$server ) ) {
                        return SQ.alert( _this.$server.data( "message" ) );
                    }
                    if ( _this.$avatar.length > 0 && !v.checkField( _this.$avatar ) ) {
                        return SQ.alert( _this.$avatar.data( "message" ) );
                    }

                    if ( _this.$content.length > 0 && !v.checkField( _this.$content ) ) {
                        return SQ.alert( _this.$content.data( "message" ) );
                    }
                    //if ( _this.$aucode.length > 0 && !v.checkField( _this.$aucode ) ) {
                    //    return SQ.alert( _this.$aucode.data( "message" ) );
                    //}

                    if ( !modulesUtil.varCodeInitCheck() ) return false;

                    _this.dataArr.game = _this.$game.val();
                    _this.dataArr.server = _this.$server.val();
                    _this.dataArr.avatar = _this.$avatar.val();
                    _this.dataArr.content = _this.$content.val();
                    _this.dataArr.aucode = _this.$aucode.val();

                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, modulesUtil.aj, {
                        url: _this.domainUrl + _this.stepOneUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {

                                /*表单显示操作*/
                                _this.$formOne.hide();
                                modulesUtil.scrollToTop();

                                $(".supply-info").attr("href","/index.php?c=complaint&a=result&id="+res.data);
                                //判断VIP等级
                                if ( parseInt(cUser.info.VIP_DEEP) >= 6 ){
                                    _this.$formResultVip.show();
                                }else{
                                    _this.$formResult.show();
                                }

                            } else {
                                modulesUtil.varCodeRefresh();
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );


                })
                .on("click","#select_game", function(){
                    $(this).siblings("span").text("").hide();
                })
        }

    };
    return {
        init:function(){
            main.init();
        }
    };
});


