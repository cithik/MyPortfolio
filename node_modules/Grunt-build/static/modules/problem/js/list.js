/**
 * Author: denghuafeng
 * Date: 2016/5/23
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/widget/sq.pager.js"
],function(common,modulesCommon){

    var ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var main = {

        init: function() {
            this.getDom();
            this.event();
            this.problemTypeInit();
        },
        domainUrl: "http://kf.37.com/index.php",
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$list = $(".list");
            _this.$btnStepSupply = _this.$list.find(".btn-step-supply");
            _this.$formResult = _this.$list.find("#service-form-result");
            _this.$orderListSupply = _this.$list.find(".order-list-supply");
            _this.$questionUl= _this.$list.find("#question-ul");
        },
        /*判断当前类型*/
        problemTypeInit:function(){
            var _this = this;
            _this.problemType = modulesUtil.getHashParam().type;
            if( !_this.$container.hasClass("list") ){
                return;
            }
            if( $("#side-"+_this.problemType).length > 0 ){
                $( "#side-"+_this.problemType ).addClass("focus");
            }else{
                _this.problemType = $(".service-menu li:eq(0)").data("type");
                $( "#side-"+_this.problemType ).addClass("focus");
            }
            $( "#type-name").html( $( "#side-"+_this.problemType).data("name") );
            _this.getProblemList();
        },
        /*获取热门问题js文件*/
        getProblemList: function(){

            var _this = this;
            /*提交ajax*/
            ajaxFn( $.extend( true, {}, {}, {
                url: "http://kf.37.com/static/js/hot_list/"+_this.problemType+".js",
                data: "",
                dataType: "jsonp",
                jsonpCallback:"kf_callback_hot_list",
                successCall: function( res ) {
                    if ( res ) {
                        _this.pageLiInit(res,15);
                    } else {
                        if ( res.code === -110 ) {
                            common.user.skipToLogin();
                        } else {
                            SQ.alert( res.msg );
                        }
                    }
                },
                failCall: function ( ){
                    _this.$questionUl.html("");
                    $("#common-page").html("");
                }

            } ) );

        },
        /*初始化问题列表页面*/
        pageLiInit: function(res,pageSize){
            var  _this = this,
                 listHtml = "",
                 liTpl = '<li><span></span><a href="{href}" target="_blank">{title}</a></li>',
                 ulTpl= '<ul class="question-list question-list-{id}" style="display: none;">{li}</ul>',
                 pageTotal = Math.ceil(res.length/pageSize);
            for ( var j= 1; j <= pageTotal ; j++){
                var liHtml = "";
                for ( var i = ( j-1 ) * pageSize ; i< j * pageSize ; i++ ){
                    res[i] && ( liHtml += liTpl.replace("{href}","/index.php?c=problem&a=hot_list&id="+res[i].id).replace("{title}",res[i].problem) );
                }
                listHtml += ulTpl.replace( "{id}" , j).replace( "{li}" , liHtml );
            }
            _this.$questionUl[0].innerHTML = listHtml;
            $(".question-list-1").show();
            var pager = new SQ.Pager({
                id: 'common-page', //dom id
                recordCount: res.length, // 记录数
                pageSize: pageSize, // 每页显示几个
                currentPage: 1, // 当前显示页码
                showNums: 5, // 最多同时显示页码数量
                changeHandler: function (page) {
                    $(".question-list-"+page).siblings().hide().end().show();
                    modulesUtil.scrollToTop(229);
                }, // 翻页回调函数
                emptyHandler: function () {
                }, //无数据回调函数
                btnsText: ['首页', '上一页', '下一页', '最后一页', '确定'],
                showGo: false,
                hideOnePage: false,//只有一页时，分页组件是否隐藏
                firstAndLast: true,//是否显示第一页和最后一页
                showNavBtn: true,//是否显示导航按钮
                copyTo: null,//拷贝到哪儿。（当列表上下都要显示分页时，这个就有用了）
                pageSizeBtn: null//每页条数按钮
            });
        },
        /*绑定事件*/
        event: function(){
            var _this = this;
            _this.$list
                /*点击侧边栏*/
                .on("click",".service-menu li",function(){
                    var $this =$(this);
                    //选中li并移除其他li样式
                    $this
                        .siblings().removeClass("focus")
                        .end()
                        .addClass("focus");
                    _this.problemType = $this.data("type");
                    //获取类型名字
                    $( "#type-name").html( $this.data("name") );
                    _this.getProblemList();
                })
        }

    };
    return {
        init:function(){
            main.init();
        }
    };
});
