/**
 * Author: denghuafeng
 * Date: 2016/5/14
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/plugin/jquery.ui.position.js",
    "http://ptres.37.com/js/sq/widget/sq.selectmenu.js",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js",
    "http://ptres.37.com/js/sq/widget/sq.count.js",
    "http://ptres.37.com/js/kf2016/lib/laydate/laydate.js"
],function(common,modulesCommon){
    var ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var main = {

        init: function() {
            this.getDom();
            this.event();
            this.selectInit();

        },
        domainUrl: "http://kf.37.com",
        vercodeUrl: "/index.php?c=index&a=aucode",
        verphoneCodeUrl: "/index.php?c=repair_account&a=actSentVerphoneCode",
        stepOneUrl: "/index.php?c=repair_account&a=actVerifyAccountPhone",
        stepFourUrl: "/index.php?c=repair_account&a=actAdd",
        getCityUrl: "/index.php?c=index&a=getJSONCity&p=",
        aj: {
            type: "post",
            cache: false
        },
        setIdCard: false,
        dataArr:{
            game_account: "",//需要修复的帐号
            contact_phone: "",//联系手机
            register_id_card_number:"",//注册时身份证号码
            often_login_address_1:"",//常登陆地点1
            often_login_address_2:"",//常登陆地点2
            game:"",//所在游戏
            register_email:"",//绑定邮箱
            register_phone:"",//绑定手机
            repair_reason_id:"",//修复的原因
            register_date:"",//注册日期
            register_address:"",//注册地点
            recharge_record:[],//充值记录 pay_time:"",//帐号充值记录-日期 -pay_account:"",//帐号充值记录-金额 date-money
            account_remark:"",//帐号遇到的问题
            real_name:"",//姓名
            sex:"",//性别
            contact_email:"",//联系邮箱
            player_id_card_number:""//身份证号码
        },
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$raIndex = $(".ra-index");
            _this.$serviceBar = _this.$container.find(".service-bar-1");
            _this.$serviceFromVercode = _this.$container.find(".service-form-vercode");
            _this.$formOne = _this.$container.find("#service-form-edit-one");
            _this.$formTwo = _this.$container.find("#service-form-edit-two");
            _this.$formThree = _this.$container.find("#service-form-edit-three");
            _this.$formFour = _this.$container.find("#service-form-edit-four");
        },
        /*更改serviceBar宽度*/
        _serviceBarAddClass: function(className){
            this.$serviceBar.addClass(className);
        },
        /*更改serviceBar宽度*/
        _serviceBarRemoveClass: function(className){
            this.$serviceBar.removeClass(className);
        },
        /*渲染select表单*/
        selectInit: function(){

            var s1 = new SQ.Selectmenu( {
                element: "#province1",
                width: 146,
                height: 300
            } );


            var s2 = new SQ.Selectmenu( {
                element: "#city1",
                width: 146,
                height: 300
            } );

            modulesUtil.selectCity(s1,s2,$("#city1"));

            var s3 = new SQ.Selectmenu( {
                element: "#province2",
                width: 146,
                height: 300
            } );

            var s4 = new SQ.Selectmenu( {
                element: "#city2",
                width: 146,
                height: 300
            } );

            modulesUtil.selectCity(s3,s4,$("#city2"));

            var s5 = new SQ.Selectmenu( {
                element: "#register_address_province",
                width: 146,
                height: 300
            } );

            var s6 = new SQ.Selectmenu( {
                element: "#register_address_city",
                width: 146,
                height: 300
            } );

            modulesUtil.selectCity(s5,s6,$("#register_address_city"));

            /*表单初始化设置*/
            modulesUtil.dropdown($("#select_game"));
            /*验证码初始化*/
            modulesUtil.varCodeInit();
            /*发送手机验证码初始化*/
            modulesUtil.sendPhoneCode( "contact_phone"  , "aucode" , "repair_account", "actSentVerphoneCode");

        },
        /*绑定事件*/
        event: function(){
            var _this = this,
            /*表单验证*/
            v = new SQ.Validate( {
                form: _this.$raIndex,
                successView: true
            } );
            _this.$raIndex
                /*刷新验证码*/
                //.on("click",".service-form-vercode",function(){
                //    $(this).children().attr("src",_this.vercodeUrl+"&t="+(new Date()).getTime());
                //})
                /*获取手机验证码*/
                //.on("click",".btn-code-send",function(){
                //    if ( this.className.indexOf( "disabled" ) > -1 ) return;
                //    _this.contactPhone = $( "#contact_phone" );
                //    if ( _this.contactPhone.length > 0 && !v.checkField( _this.contactPhone ) ) {
                //        return SQ.alert( _this.contactPhone.data( "message" ) );
                //    }
                //    var $this = $(this),
                //        postdata = {
                //            url: _this.domainUrl ,
                //            c:"repair_account",
                //            a:"actSentVerphoneCode",
                //            success: function( res, $el ) {
                //                $( "#save_code" ).val( "" );
                //                $( "#savecode-msg" ).text( "" );
                //            },
                //            fail: function( res, $el ) {
                //                $( "#savecode-msg" ).text( res.msg );
                //            }
                //        };
                //    modulesUtil.sendCodeDialog( function( e, d ) {
                //        modulesUtil.verifyCode( $this, $.extend( true, postdata, {
                //            contact_phone: $( "#contact_phone" ).val(),
                //            aucode: $( "#save_code" ).val(),
                //            always: function() {
                //                d.hide();
                //                $( e.target ).removeClass( "pending" ).html( "发送短信" );
                //            }
                //        } ) );
                //    });
                //})
                /*点击StepOne*/
                .on("click",".btn-step-one",function(e){
                    e.preventDefault();
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$gameAccount ) {
                        _this.$gameAccount = $( "#game_account" );
                        _this.$contactPhone = $( "#contact_phone" );
                        _this.$phoneAucode = $( "#phone_aucode" );
                    }

                    var stepOneData = {},
                        $this = $(this);

                    /*判断是否填写必填项*/
                    if ( _this.$gameAccount.length > 0 && !v.checkField( _this.$gameAccount ) ) {
                        return SQ.alert( _this.$gameAccount.data( "message" ) );
                    }
                    if ( _this.$contactPhone.length > 0 && !v.checkField( _this.$contactPhone ) ) {
                        return SQ.alert( _this.$contactPhone.data( "message" ) );
                    }
                    if ( _this.$phoneAucode.length > 0 && !v.checkField( _this.$phoneAucode ) ) {
                        return SQ.alert( _this.$phoneAucode.data( "message" ) );
                    }



                    /*获取数据*/
                    stepOneData = {
                        game_account: _this.$gameAccount.val() ,
                        contact_phone: _this.$contactPhone.val() ,
                        phone_code: _this.$phoneAucode.val()
                    };
                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, _this.aj, {
                        url: _this.domainUrl + _this.stepOneUrl,
                        data: stepOneData,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {
                                /*进度条操作*/
                                _this._serviceBarAddClass("width-215");
                                $(".sb-2").addClass("on");
                                /*表单显示操作*/
                                _this.$formOne.hide();
                                _this.$formTwo.show();
                                modulesUtil.scrollToTop(229);
                                /*数据操作*/
                                _this.dataArr.game_account = stepOneData.game_account;
                                _this.dataArr.contact_phone = stepOneData.contact_phone;

                                stepOneData.game_account && $(".game_account").html(stepOneData.game_account);
                                stepOneData.contact_phone && $(".service-form-account").html(stepOneData.contact_phone);

                            } else {
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );
                })

                /*点击StepTwo*/
                .on("click",".btn-step-two",function(e){
                    e.preventDefault();
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$registerIdCardNumber ) {
                        _this.$registerIdCardNumber = $("#register_id_card_number");//注册时身份证号码
                        _this.$province1= $("#province1");//常登陆地点1
                        _this.$city1= $("#city1");//常登陆地点1
                        _this.$province2= $("#province2");//常登陆地点2
                        _this.$city2= $("#city2");//常登陆地点2
                        _this.$game = $("#game");//所在游戏
                        _this.$registerEmail = $("#register_email");//绑定邮箱
                        _this.$registerPhone = $("#register_phone");//绑定手机
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$registerIdCardNumber.length > 0 && !v.checkField( _this.$registerIdCardNumber ) ) {
                        return SQ.alert( _this.$registerIdCardNumber.data( "message" ) );
                    }
                    /*判断地址*/
                    if ( !(_this.$province1.val() > 0) || !(_this.$city1.val() > 0) ) {
                        return SQ.alert( "请选择完整帐号常用登录地点1信息~" );
                    }

                    if ( _this.$game.length > 0 && !v.checkField( _this.$game ) ) {
                        return SQ.alert( _this.$game.data( "message" ) );
                    }
                    if ( _this.$registerEmail.length > 0 && !v.checkField( _this.$registerEmail ) ) {
                        return SQ.alert( _this.$registerEmail.data( "message" ) );
                    }
                    if ( _this.$registerPhone.length > 0 && !v.checkField( _this.$registerPhone ) ) {
                        return SQ.alert( _this.$registerPhone.data( "message" ) );
                    }
                    _this.$repairReasonId = $("input[name='repair_reason_id']:checked");
                    if ( !_this.$repairReasonId.val() ) {
                        return SQ.alert( "请选择帐号修复的原因" );
                    }

                    /*获取数据*/
                    _this.dataArr.register_id_card_number = _this.$registerIdCardNumber.val();//注册时身份证号码
                    _this.dataArr.often_login_address_1 = _this.$province1.children("option:checked").html() +"-"+ _this.$city1.children("option:checked").html();//常登陆地点1
                    _this.dataArr.often_login_address_2 = ( _this.$city2.val() > 0 ) ? _this.$province2.children("option:checked").html() +"-"+ _this.$city2.children("option:checked").html() : "";//常登陆地点2
                    _this.dataArr.game = _this.$game.val();//所在游戏
                    _this.dataArr.register_email = _this.$registerEmail.val();//绑定邮箱
                    _this.dataArr.register_phone = _this.$registerPhone.val();//绑定手机
                    _this.dataArr.repair_reason_id = _this.$repairReasonId.val();//修复的原因

                    /*设置后面的身份证和邮箱*/
                    if ( !_this.setIdCard  ){
                        $("#player_id_card").val( _this.dataArr.register_id_card_number );
                        $("#contact_email") .val( _this.dataArr.register_email );
                        _this.setIdCard = true;
                    }

                    /*进度条操作*/
                    _this._serviceBarAddClass("width-350");
                    $(".sb-3").addClass("on");
                    /*表单显示操作*/
                    _this.$formTwo.hide();
                    _this.$formThree.show();
                    modulesUtil.scrollToTop(229);
                })
                /*点击StepThree*/
                .on("click",".btn-step-three",function(e){
                    e.preventDefault();
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$registerDate ) {
                        _this.$registerDate = $("#register_date");//注册日期
                        _this.$registerAddress= $("#register_address");//注册地点
                        _this.$payTime= $("#pay_time");//帐号充值记录-日期
                        _this.$payAccount = $("#pay_account");//帐号充值记录-金额
                        _this.$accountRemark = $("#account_remark");//帐号遇到的问题
                        _this.$registerAddressProvince = $("#register_address_province");
                        _this.$registerAddressCity = $("#register_address_city");

                    }

                    var isNum = true;
                    //非必填项充值记录检测
                    $(".charge-child").children("input[name='pay_account']").each(function(){
                        var $this = $(this);
                        if( $this.val() && $this.prev()[0].value && !SQ.Validate.methods.num( "field",$this.val() )  ){
                            isNum = false;
                        }
                    });

                    if ( !isNum ){
                        return SQ.alert("请填写整数金额,如无充值金额填0");
                    }

                    /*获取数据*/
                    _this.dataArr.register_date = ( _this.$registerDate[0].value != "请选择注册日期,若遗忘可大致填写") ? _this.$registerDate[0].value : "";

                    //获取帐号充值记录
                    _this.dataArr.recharge_record = modulesUtil.rechargeRecordArr();

                    _this.dataArr.account_remark = _this.$accountRemark.val();
                    _this.dataArr.register_address = ( _this.$registerAddressCity.val() > 0 ) ? _this.$registerAddressProvince.children("option:checked").html() +"-"+ _this.$registerAddressCity.children("option:checked").html() : "";//常登陆地点2

                    /*进度条操作*/
                    _this._serviceBarAddClass("width-485");
                    $(".sb-4").addClass("on");
                    /*表单显示操作*/
                    _this.$formThree.hide();
                    _this.$formFour.show();
                    modulesUtil.scrollToTop(229);
                })
                /*点击StepFour*/
                .on("click",".btn-step-four",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$realName ) {
                        _this.$realName = $("#real_name");//姓名
                        _this.$sex= $("#sex");//性别
                        _this.$contactEmail= $("#contact_email");//联系邮箱
                        _this.$playerIdCard = $("#player_id_card");//身份证号码
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$realName.length > 0 && !v.checkField( _this.$realName ) ) {
                        return SQ.alert( _this.$realName.data( "message" ) );
                    }
                    if ( !($("input[name='sex']:checked").length > 0) ) {
                        return SQ.alert( "请选择性别" );
                    }
                    if ( _this.$contactEmail.length > 0 && !v.checkField( _this.$contactEmail ) ) {
                        return SQ.alert( _this.$contactEmail.data( "message" ) );
                    }
                    if ( _this.$playerIdCard.length > 0 && !v.checkField( _this.$playerIdCard ) ) {
                        return SQ.alert( _this.$playerIdCard.data( "message" ) );
                    }

                    if( parent.imgCount === 0 ) {
                        return SQ.alert("请上传身份证原件扫描件");
                    }

                    //判断是否阅读用户协议
                    if($("input[name='bind']:checked").length == 0 ){
                        return SQ.alert( "请认真阅读并同意用户协议~" );
                    }

                    /*获取数据*/
                    _this.dataArr.real_name = _this.$realName.val();
                    _this.dataArr.sex= $("input[name='sex']:checked").val();
                    _this.dataArr.contact_email=_this.$contactEmail.val();
                    _this.dataArr.player_id_card_number = _this.$playerIdCard.val();

                    $this.addClass( "pending" );
                    $this.html("提交中...");
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, _this.aj, {
                        url: _this.domainUrl + _this.stepFourUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {
                                location.href = res.data;
                            } else {
                                modulesUtil.varCodeRefresh();
                                $this.html("完成，提交");
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );
                })
                .on("click",".btn-return-one",function(){
                    /*进度条操作*/
                    _this._serviceBarRemoveClass("width-215");
                    $(".sb-2").removeClass("on");
                    /*表单显示操作*/
                    _this.$formOne.show();
                    _this.$formTwo.hide();
                    modulesUtil.scrollToTop(229);
                })
                .on("click",".btn-return-two",function(){
                    /*进度条操作*/
                    _this._serviceBarRemoveClass("width-350");
                    $(".sb-3").removeClass("on");
                    /*表单显示操作*/
                    _this.$formTwo.show();
                    _this.$formThree.hide();
                    modulesUtil.scrollToTop(229);

                })
                .on("click",".btn-return-three",function(){
                    /*进度条操作*/
                    _this._serviceBarRemoveClass("width-485");
                    $(".sb-4").removeClass("on");
                    /*表单显示操作*/
                    _this.$formThree.show();
                    _this.$formFour.hide();
                    modulesUtil.scrollToTop(229);
                })
                /*新增帐号常用登录地*/
                .on("click",".account-address-add",function(){
                    $(this)
                        .hide()
                        .parents(".service-form-tr").removeClass("service-form-tr-add");
                    $(".account-address-2").show();
                })
                /*充值记录增加*/
                .on("click",".service-recharge-add",function(){
                    modulesUtil.rechargeRecordInit( 10 );
                })
                /*充值记录减少*/
                .on("click",".recharge-del",function(){
                    var $this = $(this);
                    modulesUtil.rechargeRecordDel( $this );
                })
                /*帐号不对返回*/
                .on("click",".account-return",function(){
                    _this._serviceBarRemoveClass("width-215");
                    $(".sb-2").removeClass("on");
                    /*表单显示操作*/
                    _this.$formOne.show();
                    _this.$formTwo.hide();
                    modulesUtil.scrollToTop(229);
                })
                /*联系手机不对返回*/
                .on("click",".phone-return",function(){
                    _this.$serviceBar.removeClass("width-215").removeClass("width-350").removeClass("width-485");
                    $(".sb-2,.sb-3,.sb-4").removeClass("on");
                    /*表单显示操作*/
                    _this.$formOne.show();
                    _this.$formFour.hide();
                    modulesUtil.scrollToTop(229);
                })
                /*点击用户更协议*/
                .on("click",".is-agreement",function(){
                    var $this = $(this);
                    if( $("input[name='bind']:checked").length ){
                        $this.children("span").addClass("on")
                    }else{
                        $this.children("span").removeClass("on")
                    }
                })
                .on("click","#select_game", function(){
                    $(this).siblings("span").text("").hide();;
                })
        }

    };
    return {
        init:function(){
            main.init();
        }
    };
});

