/**
 * Author: denghuafeng
 * Date: 2016/5/13
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js"
],function(common,modulesCommon){
    var ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var login = {
        init: function() {
            this.getDom();
            this.event();
        },
        domainUrl: "http://kf.37.com",
        checkUrl: "/index.php?c=repair_account&a=actCheck",
        dataArr:{
            game_account: "",//帐号
            id: "",//服务编码
            password:""//查询密码
        },
        getDom: function(){
            var _this = this;
            _this.$raLogin = $(".ra-login");
        },
        //事件
        event: function(){
            var _this = this;
            v1 = new SQ.Validate( {
                form: _this.$raLogin,
                successView: true
            } );
            $(document)
                .on("click",".btn-login",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$realName ) {
                        _this.$gameAccount = $("#game_account");//帐号
                        _this.$billNumber= $("#bill_number");//服务编码
                        _this.$password= $("#password");//查询密码
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$gameAccount.length > 0 && !v1.checkField( _this.$gameAccount ) ) {
                        return SQ.alert( _this.$gameAccount.data( "message" ) );
                    }
                    if ( _this.$billNumber.length > 0 && !v1.checkField( _this.$billNumber ) ) {
                        return SQ.alert( _this.$billNumber.data( "message" ) );
                    }
                    if ( _this.$password.length > 0 && !v1.checkField( _this.$password ) ) {
                        return SQ.alert( _this.$password.data( "message" ) );
                    }

                    /*获取数据*/
                    _this.dataArr.game_account = _this.$gameAccount.val();
                    _this.dataArr.id = _this.$billNumber.val();
                    _this.dataArr.password = _this.$password.val();

                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, _this.aj, {
                        url: _this.domainUrl + _this.checkUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {
                                location.href = res.data;
                            } else {
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );
                })
                /*如何获取服务编号和查询密码？*/
                .on("click",".help-btn",function(){
                    $(".service-tips-help").show();
                    modulesUtil.scrollToTop( "280" );
                })
        }
    };
    return {
        init:function(){
            login.init();
        }
    };
});

