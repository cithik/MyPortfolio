/**
 * Author: denghuafeng
 * Date: 2016/5/25
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js"
],function(common,modulesCommon){
    var ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var main = {
        init: function() {
            this.getDom();
            this.selectInit();
            this.event();
        },
        domainUrl: "http://kf.37.com",
        checkUrl: "/index.php?c=repair_account&a=actSecondAdd",
        dataArr:{
            register_email: "",//注册邮箱
            register_phone: "",//注册手机
            often_login_address_1:"",//常登陆地点1
            recharge_record:[],//充值记录
            register_date:"",//注册日期
            register_address:"",//注册地址
            account_remark:"",//帐号遇到的情况
            second_reply:"",//用户补充回复
            id :""
        },
        getDom: function(){
            var _this = this;
            _this.$raCheck = $(".ra-check");
        },
        /*渲染select表单*/
        selectInit: function() {

            var s1 = new SQ.Selectmenu({
                element: "#province",
                width: 146,
                height: 300
            });


            var s2 = new SQ.Selectmenu({
                element: "#city",
                width: 146,
                height: 300
            });

            modulesUtil.selectCity(s1, s2, $("#city"));

            var s3 = new SQ.Selectmenu({
                element: "#register_province",
                width: 146,
                height: 300
            });


            var s4 = new SQ.Selectmenu({
                element: "#register_city",
                width: 146,
                height: 300
            });

            modulesUtil.selectCity(s3, s4, $("#register_city"));
        },
        //事件
        event: function(){
            var _this = this;
            v1 = new SQ.Validate( {
                form: _this.$raCheck,
                successView: true
            } );

            _this.$raCheck
                .on("click",".step-btn-submit",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$registerEmail ) {
                        _this.$registerEmail = $("#register_email");
                        _this.$registerPhone = $("#register_phone");
                        _this.$oftenLoginAddress1 = $("#often_login_address_1");
                        _this.$rechargeAccount = $("#recharge_account");
                        _this.$registerDate = $("#register_date");
                        _this.$registerAddress = $("#register_address");
                        _this.$accountRemark = $("#account_remark");
                        _this.$secondReply = $("#second_reply");
                        _this.$province = $("#province");
                        _this.$city = $("#city");
                        _this.$registerProvince = $("#register_province");
                        _this.$registerCity = $("#register_city");
                        _this.billNumber = $("#bill_number");
                    }

                    //是否需要传身份证
                    if ( $("#has_id_card").length > 0  ){
                        _this.dataArr.has_id_card = 1;
                        if( parent.imgCount === 0  ){
                            return SQ.alert( "请上传玩家身份证扫描件" );
                        }
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$registerEmail.length > 0 && !v1.checkField( _this.$registerEmail ) ) {
                        return SQ.alert( _this.$registerEmail.data( "message" ) );
                    }
                    if ( _this.$registerPhone.length > 0 && !v1.checkField( _this.$registerPhone ) ) {
                        return SQ.alert( _this.$registerPhone.data( "message" ) );
                    }

                    /*常登陆地点*/
                    if ( _this.$province.length > 0 ){
                        if ( !(_this.$province.val() > 0) || !(_this.$city.val() > 0) ) {
                            return SQ.alert( "请选择完整帐号常用登录地点信息" );
                        }
                    }
                    if ( $(".charge-child").length > 0 ) {
                        //判断帐号充值
                        if (modulesUtil.rechargeRecordCheck()) {
                            return false;
                        }
                    }

                    if ( _this.$registerDate.length > 0 && !_this.$registerDate[0].value ) {
                        return SQ.alert( _this.$registerDate.data( "message" ) );
                    }

                    /*注册地址*/
                    if ( _this.$registerProvince.length > 0 ) {
                        if (!(_this.$registerProvince.val() > 0) || !(_this.$registerCity.val() > 0)) {
                            return SQ.alert("请选择完整帐号注册地址信息");
                        }
                    }
                    if ( _this.$accountRemark.length > 0 && !v1.checkField( _this.$accountRemark ) ) {
                        return SQ.alert( _this.$accountRemark.data( "message" ) );
                    }
                    if ( _this.$secondReply.length > 0 && !v1.checkField( _this.$secondReply ) ) {
                        return SQ.alert( _this.$secondReply.data( "message" ) );
                    }


                    /*获取数据*/
                    _this.dataArr.register_email        = _this.$registerEmail.val();
                    _this.dataArr.register_phone        = _this.$registerPhone.val();
                    _this.$city.val() && ( _this.dataArr.often_login_address_1 = _this.$province.children("option:checked").html() +"-"+ _this.$city.children("option:checked").html() );//常登陆地点1


                    //获取帐号充值记录
                    _this.dataArr.recharge_record = modulesUtil.rechargeRecordArr();

                    _this.dataArr.register_date       = _this.$registerDate.length ? _this.$registerDate[0].value : "";
                    _this.$registerCity.val() && (_this.dataArr.register_address = _this.$registerProvince.children("option:checked").html() +"-"+ _this.$registerCity.children("option:checked").html() );//常登陆地点2

                    _this.dataArr.account_remark        = _this.$accountRemark.val();
                    _this.dataArr.second_reply          = _this.$secondReply.val();
                    _this.dataArr.id = _this.billNumber.val();

                    if ( !_this.dataArr.often_login_address_1  ) {
                        delete _this.dataArr.often_login_address_1;
                    }
                    if ( !_this.dataArr.register_address  ) {
                        delete _this.dataArr.register_address;
                    }
                    if ( !_this.dataArr.register_date  ) {
                        delete _this.dataArr.register_date;
                    }
                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, _this.aj, {
                        url: _this.domainUrl + _this.checkUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {
                               SQ.alert( res.msg ,function(){
                                   location.reload();
                               } );
                            } else {
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );
                })
                /*充值记录增加*/
                .on("click",".service-recharge-add",function(){
                    modulesUtil.rechargeRecordInit( 10 );
                })
                /*充值记录减少*/
                .on("click",".recharge-del",function(){
                    var $this = $(this);
                    modulesUtil.rechargeRecordDel( $this );
                });
        }
    };
    return {
        init:function(){
            main.init();
        }
    };
});
