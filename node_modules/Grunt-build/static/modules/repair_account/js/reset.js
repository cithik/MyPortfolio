/**
 * Author: denghuafeng
 * Date: 2016/5/17
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/plugin/jquery.ui.position.js",
    "http://ptres.37.com/js/sq/widget/sq.selectmenu.js",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js",
    "http://ptres.37.com/js/sq/widget/sq.count.js"
],function(common,modulesCommon){
    var ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var reset = {

        init: function() {
            this.getDom();
            this.event();
            this.selectInit();
        },
        domainUrl: "http://kf.37.com",
        vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
        verphoneCodeUrl: "/index.php?c=repair_account&a=sendPhoneCode",//发送手机验证码
        veremailCodeUrl: "/index.php?c=repair_account&a=sendEmailCode",//发送邮箱验证码
        stepOneUrl: "/index.php?c=repair_account&a=actVerifyAccountPhone",
        stepFourUrl: "/index.php?c=repair_account&a=actReset",
        getCityUrl: "/index.php?c=index&a=getJSONCity&p=",
        aj: {
            type: "post",
            cache: false
        },
        dataArr:{
            new_pwd: "",//新密码
            r_new_pwd: "",//重复新密码
            new_phone:"",//手机
            phone_code:"",//手机验证码
            new_email:"",//邮箱
            email_code:"",//邮箱验证码
            question_1:"",//问题1
            answer_1:"",//答案1
            question_2:"",//问题2
            answer_2:"",//答案2
            new_second_pwd:"",//平台二级密码
            r_new_second_pwd:"",//重复平台二级密码
            is_unbind_safe_app:"",//是否解绑手机令牌
            s:""//秘钥
        },
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$raReset = $(".ra-reset");
            _this.$serviceBar = _this.$raReset.find(".service-bar-1");
            _this.$serviceFromVercode = _this.$raReset.find(".service-form-vercode");
            _this.$formOne = _this.$raReset.find("#service-form-edit-one");
            _this.$formTwo = _this.$raReset.find("#service-form-edit-two");
            _this.$formThree = _this.$raReset.find("#service-form-edit-three");
            _this.$formFour = _this.$raReset.find("#service-form-edit-four");
            _this.$formResult = _this.$raReset.find("#service-form-result");
            _this.$serviceOther = _this.$raReset.find(".service-other")
        },
        /*更改serviceBar宽度*/
        _serviceBarAddClass: function(className){
            this.$serviceBar.addClass(className);
        },
        /*更改serviceBar宽度*/
        _serviceBarRemoveClass: function(className){
            this.$serviceBar.removeClass(className);
        },
        /*渲染select表单*/
        selectInit: function(){
            var _this = this;

            var s1 = new SQ.Selectmenu( {
                element: "#question_1",
                width: 296,
                height: 300
            } );


            var s2 = new SQ.Selectmenu( {
                element: "#question_2",
                width: 296,
                height: 300
            } );

            var dIndex;
            s1.bind( "change", function( item ) {
                if ( !s2.isRefresh ) {
                    s2.refresh();
                }

                if ( item.index > 0 ) {
                    if ( dIndex > 0 ) {
                        s2.toggleItemDiabled( dIndex );
                    }
                    s2.toggleItemDiabled( dIndex=item.index );
                }
            });
            var dIndex2;
            s2.bind( "change", function( item ) {
                if ( !s1.isRefresh ) {
                    s1.refresh();
                }

                if ( item.index > 0 ) {
                    if ( dIndex2 > 0 ) {
                        s1.toggleItemDiabled( dIndex2 );
                    }
                    s1.toggleItemDiabled( dIndex2=item.index );
                }
            });

        },
        /*绑定事件*/
        event: function(){
            var _this = this,
            /*表单验证*/
            v = new SQ.Validate( {
                form: _this.$raReset,
                successView: true
            } );
            _this.$raReset
                /*刷新验证码*/
                .on("click",".service-form-vercode",function(){
                    $(this).children().attr("src",_this.vercodeUrl+"&t="+(new Date()).getTime());
                })
                /*获取手机验证码*/
                .on("click",".btn-code-send",function(){
                    if ( this.className.indexOf( "disable" ) > -1 ) return;
                    _this.newPhone = $( "#new_phone" );
                    if ( _this.newPhone.length > 0 && !v.checkField( _this.newPhone ) ) {
                        return SQ.alert( _this.newPhone.data( "message" ) );
                    }
                    var $this = $(this),
                        postdata = {
                            url: _this.domainUrl ,
                            c:"repair_account",
                            a:"sendPhoneCode",
                            success: function( res, $el ) {
                                $( "#save_code" ).val( "" );
                                $( "#savecode-msg" ).text( "" );
                            },
                            fail: function( res, $el ) {
                                $( "#savecode-msg" ).text( res.msg );
                            }
                        };

                    modulesUtil.sendCodeDialog( function( e, d ) {
                        modulesUtil.verifyCode( $this, $.extend( true, postdata, {
                            phone: $( "#new_phone" ).val(),
                            safe_code_phone: $( "#save_code" ).val(),
                            always: function() {
                                d.hide();
                                $( e.target ).removeClass( "pending" ).html( "发送短信" );
                            }
                        } ) );
                    });
                })
                /*获取邮箱验证码*/
                .on("click",".btn-email-code-send",function(){
                    if ( this.className.indexOf( "disable" ) > -1 ) return;
                    _this.newEmail = $( "#new_email" );
                    if ( _this.newEmail.length > 0 && !v.checkField( _this.newEmail ) ) {
                        return SQ.alert( _this.newEmail.data( "message" ) );
                    }
                    var $this = $(this),
                        postdata = {
                            url: _this.domainUrl,
                            c:"repair_account",
                            a:"sendEmailCode",
                            success: function( res, $el ) {
                                $( "#save_code_email" ).val( "" );
                                $( "#savecode-msg-email" ).text( "" );
                            },
                            fail: function( res, $el ) {
                                $( "#savecode-msg-email" ).text( res.msg );
                            }
                        };

                    modulesUtil.sendEmailCodeDialog( function( e, d ) {
                        modulesUtil.verifyCode( $this, $.extend( true, postdata, {
                            email: $( "#new_email" ).val(),
                            safe_code_email: $( "#save_code_email" ).val(),
                            always: function() {
                                d.hide();
                                $( e.target ).removeClass( "pending" ).html( "发送邮件" );
                            }
                        } ) );
                    });
                })
                /*点击StepOne*/
                .on("click",".btn-step-one",function(e){
                    e.preventDefault();
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$newPwd ) {
                        _this.$newPwd = $( "#new_pwd" );
                        _this.$rNewPwd = $( "#r_new_pwd" );
                    }
                    /*获取秘钥*/
                    _this.dataArr.s = $("#s").val();

                    /*判断是否填写必填项*/
                    if ( _this.$newPwd.length > 0 && !v.checkField( _this.$newPwd ) ) {
                        return SQ.alert( _this.$newPwd.data( "message" ) );
                    }
                    if ( _this.$rNewPwd.length > 0 && !v.checkField( _this.$rNewPwd ) ) {
                        return SQ.alert( _this.$rNewPwd.data( "message" ) );
                    }

                    if( _this.$newPwd.val() !== _this.$rNewPwd.val() ){
                        return SQ.alert( "新密码与确认新密码不一致，请重新填写！" );
                    }

                    /*进度条操作*/
                    _this._serviceBarAddClass("width-215");
                    $(".sb-2").addClass("on");
                    /*表单显示操作*/
                    _this.$formOne.hide();
                    _this.$formTwo.show();
                    modulesUtil.scrollToTop(229);
                    /*数据操作*/
                    _this.dataArr.new_pwd = _this.$newPwd.val();
                    _this.dataArr.r_new_pwd = _this.$rNewPwd.val();

                })

                /*点击StepTwo*/
                .on("click",".btn-step-two",function(e){
                    e.preventDefault();
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$newPhone ) {
                        _this.$newPhone = $("#new_phone");//手机
                        _this.$phoneCode= $("#phone_code");//手机验证码
                        _this.$newEmail= $("#new_email");//邮箱
                        _this.$emailCode= $("#email_code");//邮箱验证码
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$newPhone.length > 0 && !v.checkField( _this.$newPhone ) ) {
                        return SQ.alert( _this.$newPhone.data( "message" ) );
                    }
                    /*判断地址*/
                    if ( _this.$phoneCode.length > 0 && !v.checkField( _this.$phoneCode ) ) {
                        return SQ.alert( _this.$phoneCode.data( "message" ) );
                    }
                    if ( _this.$newEmail.length > 0 && !v.checkField( _this.$newEmail ) ) {
                        return SQ.alert( _this.$newEmail.data( "message" ) );
                    }

                    if ( _this.$emailCode.length > 0 && !v.checkField( _this.$emailCode ) ) {
                        return SQ.alert( _this.$emailCode.data( "message" ) );
                    }
                    if ( $("input[name='is_bind_safe_app']").length > 0 && $("input[name='is_bind_safe_app']:checked").val() ){
                        _this.dataArr.is_unbind_safe_app = $("input[name='is_bind_safe_app']:checked").val();
                    }

                    /*获取数据*/
                    _this.dataArr.new_phone = _this.$newPhone.val();
                    _this.dataArr.phone_code=_this.$phoneCode.val();
                    _this.dataArr.new_email= _this.$newEmail.val();
                    _this.dataArr.email_code = _this.$emailCode.val();


                    /*进度条操作*/
                    _this._serviceBarAddClass("width-350");
                    $(".sb-3").addClass("on");
                    /*表单显示操作*/
                    _this.$formTwo.hide();
                    _this.$formThree.show();
                    modulesUtil.scrollToTop(229);
                })
                /*点击StepThree*/
                .on("click",".btn-step-three",function(e){
                    e.preventDefault();
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$question1 ) {
                        _this.$question1 = $("#question_1");//问题1
                        _this.$answer1= $("#answer_1");//答案1
                        _this.$question2= $("#question_2");//问题2
                        _this.$answer2 = $("#answer_2");//答案2
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$question1.length > 0 && !parseInt(_this.$question1.val()) ) {
                        return SQ.alert( _this.$question1.data( "message" ) );
                    }
                    if ( _this.$answer1.length > 0 && !v.checkField( _this.$answer1 ) ) {
                        return SQ.alert( _this.$answer1.data( "message" ) );
                    }
                    if ( _this.$question2.length > 0 && !parseInt(_this.$question2.val())  ) {
                        return SQ.alert( _this.$question2.data( "message" ) );
                    }
                    if ( _this.$answer2.length > 0 && !v.checkField( _this.$answer2 ) ) {
                        return SQ.alert( _this.$answer2.data( "message" ) );
                    }


                    /*获取数据*/
                    _this.dataArr.question_1 = _this.$question1.val();
                    _this.dataArr.answer_1= _this.$answer1.val();
                    _this.dataArr.question_2 = _this.$question2.val();
                    _this.dataArr.answer_2=_this.$answer2.val();

                    /*进度条操作*/
                    _this._serviceBarAddClass("width-485");
                    $(".sb-4").addClass("on");
                    /*表单显示操作*/
                    _this.$formThree.hide();
                    _this.$formFour.show();
                    modulesUtil.scrollToTop(229);
                })
                /*点击StepFour*/
                .on("click",".btn-step-four",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$newSecondPwd ) {
                        _this.$newSecondPwd = $("#new_second_pwd");//平台二级密码
                        _this.$rNewSecondPwd= $("#r_new_second_pwd");//重复平台二级密码

                    }



                    /*判断是否填写必填项*/
                    if ( _this.$newSecondPwd.length > 0 && !v.checkField( _this.$newSecondPwd ) ) {
                        return SQ.alert( _this.$newSecondPwd.data( "message" ) );
                    }
                    if ( _this.$rNewSecondPwd.length > 0 && !v.checkField( _this.$rNewSecondPwd ) ) {
                        return SQ.alert( _this.$rNewSecondPwd.data( "message" ) );
                    }

                    if( _this.$newSecondPwd.val() !== _this.$rNewSecondPwd.val() ){
                        return SQ.alert( "新平台二级密码与确认新平台二级密码不一致，请重新填写！" );
                    }
                    if( _this.$newPwd.val() === _this.$rNewSecondPwd.val() ){
                        return SQ.alert( "新平台二级密码请不要与平台密码相同，请重新填写！" );
                    }

                    /*获取数据*/
                    _this.dataArr.new_second_pwd=_this.$newSecondPwd.val();
                    _this.dataArr.r_new_second_pwd = _this.$rNewSecondPwd.val();

                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, _this.aj, {
                        url: _this.domainUrl + _this.stepFourUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {

                                /*进度条操作*/
                                _this._serviceBarAddClass("width-559");
                                $(".sb-5").addClass("on");
                                /*表单显示操作*/
                                _this.$formFour.hide();
                                _this.$formResult.show();
                                _this.$serviceOther.show();
                                modulesUtil.scrollToTop(229);
                            } else {
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );
                })
                .on("click",".btn-return-one",function(){
                    /*进度条操作*/
                    _this._serviceBarRemoveClass("width-215");
                    $(".sb-2").removeClass("on");
                    /*表单显示操作*/
                    _this.$formOne.show();
                    _this.$formTwo.hide();
                    modulesUtil.scrollToTop(229);
                })
                .on("click",".btn-return-two",function(){
                    /*进度条操作*/
                    _this._serviceBarRemoveClass("width-350");
                    $(".sb-3").removeClass("on");
                    /*表单显示操作*/
                    _this.$formTwo.show();
                    _this.$formThree.hide();
                    modulesUtil.scrollToTop(229);

                })
                .on("click",".btn-return-three",function(){
                    /*进度条操作*/
                    _this._serviceBarRemoveClass("width-485");
                    $(".sb-4").removeClass("on");
                    /*表单显示操作*/
                    _this.$formThree.show();
                    _this.$formFour.hide();
                    modulesUtil.scrollToTop(229);
                })
        }

    };
    return {
        init:function(){
            reset.init();
        }
    };
});

