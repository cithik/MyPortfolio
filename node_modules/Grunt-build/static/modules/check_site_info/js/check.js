/**
 * Author: honglingbo
 * Date: 2016/5/20
 * Plugin Name: check_site_info.js
 * Description: 官方QQ验证模块
 * init: init, //对外暴露执行函数
 */

define(
	[
		"common",
		"modules/modules_common",
		"http://ptres.37.com/js/sq/widget/sq.selectmenu.js",
		"http://ptres.37.com/js/sq/plugin/jquery.ui.position.js",
		"http://ptres.37.com/js/sq/widget/sq.validate2015.js",
		"http://ptres.37.com/js/kf2016/lib/laydate/laydate.js",
		"http://ptres.37.com/js/sq/widget/sq.store.js"
	],
    function(common, modulesUtilCommon) {
    	var ajaxFn = common.util.callApi,
			modulesUtil = modulesUtilCommon.modulesUtil,
			API = {
				checkcode: 'http://kf.37.com/index.php?c=index&a=check_code', //验证码接口
				checkInfo: 'http://kf.37.com/index.php?c=site_qq&a=actTest' //验证接口
			},
			main = {
				init: function() {
					var _this = this;
					_this.getDOM();
					_this.leftMenuInit();
					_this.selectInit();
					_this.event();
				},
				vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
				aj: {
					type: "post",
					cache: false
				},
				/**
				 * 绑定DOM
				 */
				getDOM: function() {
					var _this = this;
					_this.$form = $('#service-form-edit');
					_this.$saveCode = $('#aucode');
					_this.$type = $('#type');
				},
				/**
				 * 左侧导航初始化
				 */
				leftMenuInit: function(){
					$("#side-site-qq").addClass("focus");
				},
				/**
				 * 插件生成select
				 */
				selectInit: function() {
					var type = new SQ.Selectmenu({
							width: 296,
							height: 300,
							element: "#type"
						}),
						$info = $('#info'),
						$type = $('#type');

					type.bind("select",function(){
						$('.my-intro,.result').hide();
						$("#info").val("");
					});
					var _this = this;
					//绑定选择切换事件，更改info的验证规则
					type.bind("change",function(items){
						var value = items.value,
							info = $info.val();
						$type.nextAll('.field-error-message').text('').hide();
						$info.focus();
						switch(value) {
							case 'qq': {
								$type.unbind();
								$info.data('message', '请输入有效的QQ号码').attr('placeholder', '请输入有效的QQ号码');
								var isChecked = /^[1-9][0-9]{4,19}$/.test( info );
								if(!isChecked) {
									$info.nextAll('.field-error-message').text('请输入有效的QQ号码').show();
								}else {
									$info.nextAll('.field-error-message').text('').hide();
								}
								_this.$form
									.on('keyup', '#info', function(e) {
										info = $info.val();
										//验证qq规则
										isChecked = /^[1-9][0-9]{4,19}$/.test( info );
										if(!isChecked) {
											$info.nextAll('.field-error-message').text('请输入有效的QQ号码').show();
										}else {
											$info.nextAll('.field-error-message').text('').hide();
										}
								});

								break;
							}
							case 'phone': {
								$type.unbind();
								$info.data('message', '请输入有效的手机号码').attr('placeholder', '请输入有效的手机号码');
								var isChecked = /^0?(1[38][0-9]|15[0-35-9]|14[57]|17[0678])[0-9]{8}$/.test( info );
								if(!isChecked) {
									$info.nextAll('.field-error-message').text('请输入有效的手机号码').show();
								}else {
									$info.nextAll('.field-error-message').text('').hide();
								}
								_this.$form
									.on('keyup', '#info', function(e) {
										info = $info.val();
										//验证qq规则
										isChecked = /^0?(1[38][0-9]|15[0-35-9]|14[57]|17[0678])[0-9]{8}$/.test( info );
										if(!isChecked) {
											$info.nextAll('.field-error-message').text('请输入有效的手机号码').show();
										}else {
											$info.nextAll('.field-error-message').text('').hide();
										}
								});
								break;
							}
							case 'email': {
								$type.unbind();
								$info.data('message', '请输入有效的邮箱').attr('placeholder', '请输入有效的邮箱');
								var isChecked = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test( info );
								if(!isChecked) {
									$info.nextAll('.field-error-message').text('请输入有效的邮箱').show();
								}else {
									$info.nextAll('.field-error-message').text('').hide();
								}
								_this.$form
									.on('keyup', '#info', function(e) {
										info = $info.val();
										//验证qq规则
										isChecked = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test( info );
										if(!isChecked) {
											$info.nextAll('.field-error-message').text('请输入有效的邮箱').show();
										}else {
											$info.nextAll('.field-error-message').text('').hide();
										}
								});


								break;
							}
							case 'wechat': {
								$type.unbind();
								$info.data('message', '请输入有效的微信号').attr('placeholder', '请输入有效的微信号');
								var isChecked = /^[a-zA-Z][a-zA-Z0-9-_]{5,19}$/.test( info );
								if(!isChecked) {
									$info.nextAll('.field-error-message').text('请输入有效的微信号').show();
								}else {
									$info.nextAll('.field-error-message').text('').hide();
								}
								_this.$form
									.on('keyup', '#info', function(e) {
										info = $info.val();
										//验证qq规则
										isChecked = /^[a-zA-Z][a-zA-Z0-9-_]{5,19}$/.test( info );
										if(!isChecked) {
											$info.nextAll('.field-error-message').text('请输入有效的微信号').show();
										}else {
											$info.nextAll('.field-error-message').text('').hide();
										}
								});
								break;
							}
						}
						//$("input").placeholder();
						_this.v = new SQ.Validate( {
							form: _this.$form,
							successView: true
						} );
					});
				},
				/**
				 * 事件绑定
				 */
				event: function() {
					var _this = this;
						/*表单验证*/
						_this.v = new SQ.Validate( {
							form: _this.$form,
							successView: true
						} );
					_this.$form
						//绑定提交事件，验证与传输数据
						.on('click', '#commitbtn', function(e) {
							e.preventDefault();
							//隐藏个人介绍
							$('.my-intro').hide();
							var $ruledata = _this.$form.find('input[data-rule],select[data-rule]'),
								$formdata = _this.$form.find('input[name], select[name]'),
								dataObj = {}; //传参的数据对象
							//验证规则是否有错误信息
							for(var i = 0, dataLength = $ruledata.length; i<dataLength; i++) {
								var $tempdata = $ruledata.eq(i),
									ErrorText = $tempdata.nextAll('.field-error-message').text().replace(/\s+/g,"");
								if( (!_this.v.checkField($tempdata)) && ErrorText.length > 0 ) {
									SQ.alert(ErrorText);
									//$tempdata[0].focus();
									return false;
								}
							}

							//构造传参且验证是否为空
							for(var i = 0, dataLength = $formdata.length; i<dataLength; i++ ) {
								var $tempdata = $formdata.eq(i),
									ErrorText = $tempdata.nextAll('.field-error-message').text().replace(/\s+/g,"");
								if( $tempdata[0].value.length <= 0 ) {
									SQ.alert($tempdata.data('message').split(',')[0]); //弹出第一条错误信息
									//$tempdata[0].focus();
									return false;
								}

								if(ErrorText.length > 0) {
									SQ.alert(ErrorText);
									//$tempdata[0].focus();
									return false;
								}

								dataObj[$formdata[i].name] = $formdata[i].value;
							}
							ajaxFn( $.extend( true, {}, _this.aj, {
								url: API.checkInfo,
								data: dataObj,
								successCall: function( res ) {
									if ( !res ) return;
									$('#aucode').val('').siblings('.codeimg').attr('src', "http://kf.37.com/index.php?c=index&a=aucode&t="+(new Date()).getTime() ).siblings('.field-right-message').hide();
									if ( res.code == 1 ) {
										$('.field-error-message').text('');
										var data = res.data;
										//显示个人介绍
										$('.person').attr('src', data.img);
										$('.intro-text').html(data.intro);
										//显示验证结果，刷新验证码并清空
										$('#result').html(res.msg).show();
										$('.my-intro').show();
										$('body, html').animate({ scrollTop: '430px'},200);
									} else if(res.code == -1) {
										$('#result').html(res.msg).show();
									}else {
										SQ.alert( res.msg );
									}
								},
								failCall: function() {
									SQ.alert( "验证失败，请稍后再试" );
								}
							} ) );

						})
						//enter键触发提交事件
						.on('keydown', '#type, #info, #aucode', function(e) {
							if(e && e.keyCode==13){ // enter 键
								_this.$form.find('#commitbtn').trigger('click');
							}
						})
						/*刷新验证码*/
						.on("click",".codeimg",function(){
							$(this).attr("src",_this.vercodeUrl+"&t="+(new Date()).getTime());
						});
					//验证码验证
					_this.$saveCode
						.on( "keyup", function() {
							var $this = $( this ),
								$msgDom = $(this).siblings('.field-error-message'),
								$rightDom = $(this).siblings('.field-right-message'),
								msgText = $this.data( "message" );
							if ( $this.val().length == 0 ) {
								$rightDom.hide();
								$msgDom.text( "请输入验证码" ).show();
								return;
							}
							if ( $this.val().length !== 4 ) {
								$rightDom.hide();
								$msgDom.text( "验证码输入错误" ).show();
								return;
							}
							ajaxFn( $.extend( true, {}, _this.aj, {
								url: API.checkcode,
								data: {
									ajax: 1,
									safe_code: $this.val()
								},
								successCall: function( res ) {
									if ( !res ) return;
									if ( res.code !== 1 ) {
										$msgDom.text( res.msg );
									} else {
										modulesUtil.varCodeRefresh();
										$msgDom.text('').hide();
										$rightDom.text( res.msg ).show();
									}
								},
								failCall: function() {
									$msgDom.text( "验证失败，请稍后再试" );
								}
							} ) );
						} );

				}
			};
	return {
		init:function(){
			main.init();
		}
	};

});