/**
 * Author: denghuafeng
 * Date: 2016/5/18
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/plugin/jquery.ui.position.js",
    "http://ptres.37.com/js/sq/widget/sq.selectmenu.js",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js",
    "http://ptres.37.com/js/sq/widget/sq.count.js"
],function(common,modulesCommon){

    var cUser = common.user,
        ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;

    var addByPhone = {

        init: function() {
            this.getDom();
            this.event();
            /*表单初始化设置*/
            modulesUtil.dropdown($("#select_game"));
            /*验证码初始化*/
            modulesUtil.varCodeInit();
            /*发送手机验证码初始化*/
            modulesUtil.sendPhoneCode( "register_phone", "safe_code_phone",  "recover_avatar" , "sendPhoneCode" );
        },
        domainUrl: "http://kf.37.com",
        vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
        verphoneCodeUrl: "/index.php?c=recover_avatar&a=sendPhoneCode",//发送手机验证码
        stepOneUrl: "/index.php?c=recover_avatar&a=verifyPhoneCode",//第一步提交
        stepTwoUrl: "/index.php?c=recover_avatar&a=actAddByPhone",//数据提交
        dataArr:{
            register_phone:"",//验证手机
            phone_code: "",//手机验证码
            game: "",//游戏
            server:"",//服务器
            avatar:""//角色名
        },
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$raPhone = $(".ra-phone");
            _this.$serviceBar = _this.$raPhone.find(".service-bar-1");
            _this.$serviceFromVercode = _this.$raPhone.find(".service-form-vercode");
            _this.$formOne = _this.$raPhone.find("#service-form-edit-one");
            _this.$formTwo = _this.$raPhone.find("#service-form-edit-two");
            _this.$formResult = _this.$raPhone.find("#service-form-result");
            _this.$formOther = _this.$raPhone.find(".service-other");
            _this.$formResultVip = _this.$raPhone.find("#service-form-result-vip");
        },
        /*绑定事件*/
        event: function(){
            var _this = this,
            /*表单验证*/
            v = new SQ.Validate( {
                form: _this.$raPhone,
                successView: true
            } );

            _this.$raPhone
                /*获取手机验证码*/
                .on("click",".btn-code-send",function(){
                    if ( this.className.indexOf( "disable" ) > -1 ) return;
                    _this.registerPhone = $( "#register_phone" );
                    if ( _this.registerPhone.length > 0 && !v.checkField( _this.registerPhone ) ) {
                        return SQ.alert( _this.registerPhone.data( "message" ) );
                    }
                    var $this = $(this),
                        postdata = {
                            url: "http://kf.37.com/index.php",
                            c:"recover_avatar",
                            a:"sendPhoneCode",
                            success: function( res, $el ) {
                                $( "#save_code" ).val( "" );
                                $( "#savecode-msg" ).text( "" );
                            },
                            fail: function( res, $el ) {
                                $( "#savecode-msg" ).text( res.msg );
                            }
                        };

                    modulesUtil.sendCodeDialog( function( e, d ) {
                        modulesUtil.verifyCode( $this, $.extend( true, postdata, {
                            register_phone: $( "#register_phone" ).val(),
                            safe_code_phone: $( "#save_code" ).val(),
                            always: function() {
                                d.hide();
                                $( e.target ).removeClass( "pending" ).html( "发送短信" );
                            }
                        } ) );
                    });
                })
                /*点击StepOne*/
                .on("click",".btn-step-one",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$registerPhone ) {
                        _this.$registerPhone = $( "#register_phone" );
                        _this.$phoneCode = $( "#phone_code" );
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$registerPhone.length > 0 && !v.checkField( _this.$registerPhone ) ) {
                        return SQ.alert( _this.$registerPhone.data( "message" ) );
                    }
                    if ( _this.$phoneCode.length > 0 && !v.checkField( _this.$phoneCode ) ) {
                        return SQ.alert( _this.$phoneCode.data( "message" )  );
                    }

                    var stepData = {
                        register_phone : _this.$registerPhone.val(),
                        phone_code : _this.$phoneCode.val()
                    };

                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, modulesUtil.aj, {
                        url: _this.domainUrl + _this.stepOneUrl,
                        data: stepData,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {
                                /*进度条操作*/
                                _this.$serviceBar.addClass("width-215");
                                $(".sb-2").addClass("on");
                                /*表单显示操作*/
                                _this.$formOne.hide();
                                _this.$formTwo.show();
                                modulesUtil.scrollToTop(229);
                                /*数据操作*/
                                _this.dataArr.register_phone = _this.$registerPhone.val();
                                _this.dataArr.phone_code = _this.$phoneCode.val();

                            } else {
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );


                })

                /*点击StepTwo*/
                .on("click",".btn-step-two",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$newPhone ) {
                        _this.$game   = $("#game");
                        _this.$server = $("#server");
                        _this.$avatar = $("#avatar");
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$game.length > 0 && !v.checkField( _this.$game ) ) {
                        return SQ.alert( _this.$game.data( "message" ) );
                    }
                    if ( _this.$server.length > 0 && !v.checkField( _this.$server ) ) {
                        return SQ.alert( _this.$server.data( "message" ) );
                    }
                    if ( _this.$avatar.length > 0 && !v.checkField( _this.$avatar ) ) {
                        return SQ.alert( _this.$avatar.data( "message" ) );
                    }
                    /*获取数据*/
                    _this.dataArr.game = _this.$game.val();
                    _this.dataArr.server=_this.$server.val();
                    _this.dataArr.avatar= _this.$avatar.val();

                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, modulesUtil.aj, {
                        url: _this.domainUrl + _this.stepTwoUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {

                                /*进度条操作*/
                                _this.$serviceBar.addClass("width-350");
                                $(".sb-3").addClass("on");
                                /*表单显示操作*/
                                _this.$formTwo.hide();
                                _this.$formOther.show();
                                modulesUtil.scrollToTop(229);

                                $(".supply-info").attr("href","/index.php?c=recover_avatar&a=result&id="+res.data.bill_number);
                                if ( parseInt(cUser.info.VIP_DEEP) >= 6 ){
                                    _this.$formResultVip.show();
                                }else{
                                    _this.$formResult.show();
                                }

                            } else {
                                modulesUtil.varCodeRefresh();
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );

                })
                .on("click","#select_game", function(){
                    $(this).siblings("span").text("").hide();
                });
        }

    };
    return {
        init:function(){
            addByPhone.init();
        }
    };
});


