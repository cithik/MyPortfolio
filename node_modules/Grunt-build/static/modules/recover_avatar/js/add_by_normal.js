/**
 * Author: denghuafeng
 * Date: 2016/5/17
 * Plugin Name:
 * Description: .
 */
define([
    "common",
    "modules/modules_common",
    "http://ptres.37.com/js/sq/plugin/jquery.ui.position.js",
    "http://ptres.37.com/js/sq/widget/sq.selectmenu.js",
    "http://ptres.37.com/js/sq/widget/sq.validate2015.js",
    "http://ptres.37.com/js/sq/widget/sq.count.js",
    "http://ptres.37.com/js/kf2016/lib/laydate/laydate.js"
],function(common,modulesCommon){

    var cUser = common.user,
        ajaxFn = common.util.callApi,
        modulesUtil = modulesCommon.modulesUtil;


    var reset = {

        init: function() {
            this.getDom();
            this.event();
            this.selectInit();
        },
        domainUrl: "http://kf.37.com",
        vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
        stepTwoUrl: "/index.php?c=recover_avatar&a=actAddByNormal",
        getCityUrl: "/index.php?c=index&a=getJSONCity&p=",
        aj: {
            type: "post",
            cache: false
        },
        dataArr:{
            game: "",//游戏
            server: "",//服务器
            avatar:"",//角色名
            real_name:"",//注册姓名
            register_id_card_number:"",//注册身份证
            register_date:"",//注册日期
            register_address:"",//注册地址（省-市  ： 北京-北京）
            register_email:"",//绑定邮箱
            register_phone:"",//绑定手机
            send_type:"",//消息发送类型，值：register_phone  绑定手机concact_phone  联系手机
            recharge_record:[],//充值记录 pay_time:"",//帐号充值记录-日期 -pay_account:"",//帐号充值记录-金额 date-money
            aucode:"",//验证码
            contact_phone:""//
        },
        contact_phone_status : false,
        /*绑定Dom*/
        getDom: function(){
            var _this = this;
            _this.$container = $(".container");
            _this.$raNormal = $(".ra-normal");
            _this.$serviceBar = _this.$raNormal.find(".service-bar-1");
            _this.$serviceFromVercode = _this.$raNormal.find(".service-form-vercode");
            _this.$formOne = _this.$raNormal.find("#service-form-edit-one");
            _this.$formTwo = _this.$raNormal.find("#service-form-edit-two");
            _this.$formThree = _this.$raNormal.find("#service-form-edit-three");
            _this.$formFour = _this.$raNormal.find("#service-form-edit-four");
            _this.$formResult = _this.$raNormal.find("#service-form-result");
            _this.$formOther = _this.$raNormal.find(".service-other");
            _this.$formResultVip = _this.$raNormal.find("#service-form-result-vip");
        },
        /*渲染select表单*/
        selectInit: function(){

            var s1 = new SQ.Selectmenu( {
                element: "#register_address_province",
                width: 146,
                height: 300
            } );

            var s2 = new SQ.Selectmenu( {
                element: "#register_address_city",
                width: 146,
                height: 300
            } );

            modulesUtil.selectCity(s1,s2,$("#register_address_city"));
            /*验证码初始化*/
            modulesUtil.varCodeInit();
        },
        /*绑定事件*/
        event: function(){
            var _this = this,
            /*表单验证*/
            v = new SQ.Validate( {
                form: _this.$raNormal,
                successView: true
            } );
            _this.$raNormal
                /*刷新验证码*/
                .on("click",".service-form-vercode",function(){
                    $(this).children().attr("src",_this.vercodeUrl+"&t="+(new Date()).getTime());
                })
                /*点击StepOne*/
                .on("click",".btn-step-one",function(e){
                    e.preventDefault();

                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$game ) {
                        _this.$game = $( "#game" );
                        _this.$server = $( "#server" );
                        _this.$avatar = $( "#avatar" );
                    }

                    /*判断是否填写必填项*/
                    if ( _this.$game.length > 0 && !v.checkField( _this.$game ) ) {
                        return SQ.alert( _this.$game.data( "message" ) );
                    }
                    if ( _this.$server.length > 0 && !v.checkField( _this.$server ) ) {
                        return SQ.alert( _this.$server.data( "message" ) );
                    }
                    if( _this.$avatar.length > 0 && !v.checkField( _this.$avatar ) ){
                        return SQ.alert( _this.$avatar.data( "message" ) );
                    }
                    /*进度条操作*/
                    _this.$serviceBar.addClass("width-215");
                    $(".sb-2").addClass("on");
                    /*表单显示操作*/
                    _this.$formOne.hide();
                    _this.$formTwo.show();
                    modulesUtil.scrollToTop(229);
                    /*数据操作*/
                    _this.dataArr.game = _this.$game.val();
                    _this.dataArr.server = _this.$server.val();
                    _this.dataArr.avatar = _this.$avatar.val();
                })

                /*点击StepTwo*/
                .on("click",".btn-step-two",function(e){
                    e.preventDefault();
                    var $this = $(this);
                    if ( this.className.indexOf( "pending" ) > -1 ) return;
                    if ( !_this.$realName ) {
                        _this.$realName = $("#real_name");//注册姓名
                        _this.$registerIdCardNumber= $("#register_id_card_number");//注册身份证
                        _this.$registerDate= $("#register_date");//注册日期
                        _this.$registerAddress= $("#register_address");//注册地址（省-市  ： 北京-北京）
                        _this.$registerAddressProvince = $("#register_address_province");
                        _this.$registerAddressCity = $("#register_address_city");
                        _this.$registerEmail = $("#register_email");//绑定邮箱
                        _this.$registerPhone= $("#register_phone");//绑定手机
                        _this.$contactPhone= $("#contact_phone");//绑定手机
                        _this.$sendType= $("#send_type");//消息发送类型，值：register_phone  绑定手机concact_phone  联系手机
                        _this.$rechargeRecord= $("#recharge_record");//充值记录
                        _this.$payTime= $("#pay_time");//充值记录
                        _this.$payAccount= $("#pay_account");//充值记录
                        _this.$aucode= $("#aucode");//验证码

                    }

                    /*判断是否填写必填项*/
                    if ( _this.$realName.length > 0 && !v.checkField( _this.$realName ) ) {
                        return SQ.alert( _this.$realName.data( "message" ) );
                    }
                    if ( _this.$registerIdCardNumber.length > 0 && !v.checkField( _this.$registerIdCardNumber ) ) {
                        return SQ.alert( _this.$registerIdCardNumber.data( "message" ) );
                    }
                    if ( _this.$registerDate.length > 0 && ( ( _this.$registerDate[0].value == "请选择注册日期，若遗忘可大致填写" ) || !_this.$registerDate[0].value ) ) {
                        return SQ.alert( _this.$registerDate.data( "message" ) );
                    }
                    //判断地址
                    if ( !(_this.$registerAddressProvince.val() > 0) || !(_this.$registerAddressCity.val() > 0) ) {
                        return SQ.alert( "请选择完整注册地点信息~" );
                    }
                    if ( _this.$registerEmail.length > 0 && !v.checkField( _this.$registerEmail ) ) {
                        return SQ.alert( _this.$registerEmail.data( "message" ) );
                    }
                    if ( _this.$sendType.length > 0 && !v.checkField( _this.$sendType ) ) {
                        return SQ.alert( _this.$sendType.data( "message" ) );
                    }

                    if( !_this.$registerPhone.val() && !v.checkField( _this.$registerPhone ) ){
                        return SQ.alert( _this.$registerPhone.data( "message" ));
                    }

                    if( !_this.contact_phone_status ){
                        //当选择为上面的手机时
                        _this.dataArr.send_type = "register_phone";
                        _this.dataArr.contact_phone = "";
                    }else{
                        //当选择为下面的手机时
                        _this.dataArr.send_type = "contact_phone";
                        if( !_this.$contactPhone.val() && !v.checkField( _this.$contactPhone ) ){
                            return SQ.alert( _this.$contactPhone.data( "message" ));
                        }
                        _this.dataArr.contact_phone = _this.$contactPhone.val();
                    }
                    //判断帐号充值
                    if( modulesUtil.rechargeRecordCheck() ){
                        return false;
                    }
                    //判断是否填写验证码
                    //if ( _this.$aucode.length > 0 && !v.checkField( _this.$aucode ) ) {
                    //    return SQ.alert( _this.$aucode.data( "message" ) );
                    //}
                    if ( !modulesUtil.varCodeInitCheck() ) return false;

                    //判断是否阅读用户协议
                    if($("input[name='bind']:checked").length == 0 ){
                        return SQ.alert( "请认真阅读并同意用户协议~" );
                    }

                    //获取帐号充值记录
                    _this.dataArr.recharge_record = modulesUtil.rechargeRecordArr();

                    /*获取数据*/
                    _this.dataArr.real_name = _this.$realName.val();
                    _this.dataArr.register_id_card_number=_this.$registerIdCardNumber.val();
                    _this.dataArr.register_date= _this.$registerDate[0].value;;
                    _this.dataArr.register_address = _this.$registerAddressProvince.children("option:checked").html() +"-"+ _this.$registerAddressCity.children("option:checked").html();
                    _this.dataArr.register_email = _this.$registerEmail.val();
                    _this.dataArr.register_phone= _this.$registerPhone.val();

                    _this.dataArr.aucode = _this.$aucode.val();

                    $this.addClass( "pending" );
                    /*提交ajax*/
                    ajaxFn( $.extend( true, {}, _this.aj, {
                        url: _this.domainUrl + _this.stepTwoUrl,
                        data: _this.dataArr,
                        successCall: function( res ) {
                            $this.removeClass( "pending" );
                            if ( res.code === 1 ) {

                                /*进度条操作*/
                                _this.$serviceBar.addClass("width-350");
                                $(".sb-3").addClass("on");
                                /*表单显示操作*/
                                _this.$formTwo.hide();
                                _this.$formOther.show();
                                modulesUtil.scrollToTop(229);

                                $(".supply-info").attr("href","/index.php?c=clear_sec_pwd&a=result&id="+res.data.bill_number);
                                if ( parseInt(cUser.info.VIP_DEEP) >= 6 ){
                                    _this.$formResultVip.show();
                                }else{
                                    _this.$formResult.show();
                                }

                            } else {
                                modulesUtil.varCodeRefresh();
                                if ( res.code === -110 ) {
                                    common.user.skipToLogin();
                                } else {
                                    SQ.alert( res.msg );
                                }
                            }
                        }
                    } ) );

                })
                /*选择手机号*/
                .on("click",".phone-checkbox",function(){
                    var $this = $(this);
                    $this
                        .removeClass("c9").children("span").addClass("on")
                        .end()
                        .siblings(".phone-checkbox").addClass("c9").children("span").removeClass("on");

                    if($this.data("phone")  === 1){
                        $(".contact-phone").hide();
                        _this.contact_phone_status = false;
                    }else{
                        $(".contact-phone").show();
                        _this.contact_phone_status = true;
                    }
                })
                /*充值记录增加*/
                .on("click",".service-recharge-add",function(){
                    modulesUtil.rechargeRecordInit( 10 );
                })
                /*充值记录减少*/
                .on("click",".recharge-del",function(){
                    var $this = $(this);
                    modulesUtil.rechargeRecordDel( $this );
                })
                /*点击用户更协议*/
                .on("click",".is-agreement",function(){
                    var $this = $(this);
                    if( $("input[name='bind']:checked").length ){
                        $this.children("span").addClass("on")
                    }else{
                        $this.children("span").removeClass("on")
                    }
                })
                /*上一步*/
                .on("click",".btn-return-one",function(){
                    /*进度条操作*/
                    _this.$serviceBar.removeClass("width-215");
                    $(".sb-2").removeClass("on");
                    /*表单显示操作*/
                    _this.$formOne.show();
                    _this.$formTwo.hide();
                    modulesUtil.scrollToTop(229);
                })
                .on("click","#select_game", function(){
                    $(this).siblings("span").text("").hide();;
                })
        }

    };
    return {
        init:function(){
            reset.init();
        }
    };
});

