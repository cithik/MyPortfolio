/**
 * Author: honglingbo
 * Date: 2016/5/16
 * Plugin Name: report_plugin.js
 * Description: 外挂举报模块
 * init: init, //对外暴露执行函数
 */

define( [	"common",
			"modules/modules_common",
			"http://ptres.37.com/js/sq/widget/sq.selectmenu.js",
			"http://ptres.37.com/js/sq/plugin/jquery.ui.position.js?t=1383539951764",
			"http://ptres.37.com/js/sq/widget/sq.validate2015.js",
	     	"http://ptres.37.com/js/kf2016/lib/laydate/laydate.js"
	    ],
	function(common, modulesCommon) {

		var cUser = common.user,
			ajaxFn = common.util.callApi,
			modulesUtil = modulesCommon.modulesUtil,

			API = {
				checkcode: 'http://kf.37.com/index.php?c=index&a=check_code',
				addplugin: 'http://kf.37.com/index.php?c=report_plugin&a=actAdd'
			},
		main = {
			init: function() {
				var _this = this,
					usersuccess = cUser.success;
				/*修改用户名*/
				usersuccess.done(function() {
					$('#username').html(cUser.userName);
				});
				
				_this.getDOM();
				_this.leftMenuInit();
				_this.selectInit();
				_this.event();

			},
			vercodeUrl: "/index.php?c=index&a=aucode",//统一验证码
			aj: {
	            type: "post",
	            cache: false
	        },
			/**
			 * 绑定DOM
			 * @return {[type]} [description]
			 */
			getDOM: function() {
				var _this = this;
				_this.$container = $('.container');
				_this.$formOne = $('#service-form-edit');
				_this.$saveCode = $('#aucode');
				/*form*/
				// _this.
			},
			/**
			 * 左侧导航初始化
			 * @return {[type]} [description]
			 */
			leftMenuInit: function(){
	            $("#side-report-plugin").addClass("focus");
	        },
			/**
			 * 插件生成select
			 * @return {[type]} [description]
			 */
			selectInit: function() {
		        /*report*/
		        var external_select = new SQ.Selectmenu({
		            width: 296,
		            height: 300,
		            element: "#plugin_type"
		        });
				//游戏下拉框
				modulesUtil.dropdown($('#select_game'));
				/*验证码初始化*/
				modulesUtil.varCodeInit();
			},
			/**
			 * 绑定事件
			 * @return {[type]} [description]
			 */
			event: function() {
				var _this = this,
	                /*表单验证*/
	                v = new SQ.Validate( {
	                    form: _this.$formOne,
	                    successView: true
	                } );
                _this.$container
					///*刷新验证码*/
					//.on("click",".codeimg",function(){
					//	$(this).attr("src",_this.vercodeUrl+"&t="+(new Date()).getTime());
					//})
                	/*优化处理，鼠标聚焦输入框时清除兄弟元素的错误提示信息*/
                	.on('focus', 'input.col3 ', function() {
                		$(this).siblings('.field-right-message, .field-error-message').hide();
                	})
                	//.on('blur', 'input', function() {
                	//	if ($(this).attr('id') != 'aucode') {
                	//		$(this).nextAll('.field-right-message:first, .field-error-message:first').show();
                	//	}
                	//
                	//})
					.on('click', '.upload-delete', function() {
						$(this).parent().parent().remove();
					}) 
					.on('click', '#commitbtn', function() {
						if ( this.className.indexOf( "pending" ) > -1 ) return;
						var $this = $(this);
						/*ajax逻辑*/
						var formArray = _this.$formOne.serializeArray(),

							// $ruledata = _this.$form.find('input[data-rule],select[data-rule]'),
							data = {};
						/*构造传参*/
						for(var i = 0, length=formArray.length; i<length; i++) {
							//判断必填项是否有空值
							var tempdata = formArray[i],
								$tempdata = $('#'+formArray[i].name),
	            				ErrorText = $tempdata.nextAll('.field-error-message').text().replace(/\s+/g,"");
							if( tempdata.name == "select_game" ) continue;


							if (  $tempdata.attr("id") == "find_time" ){
								if( ( $tempdata[0].value == "请选择发现时间" ) ||  !$tempdata[0].value ){
									SQ.alert( $tempdata.data( "message" ).split(',')[0] );
									return false;
								}
								continue;
							}

							if( tempdata.name == "aucode" ){
								if( !$tempdata.val() ) {
									SQ.alert('请输入验证码');
									//$tempdata.hasClass("no-focus") || $tempdata.focus();
									return false;
								}
								if( $tempdata.data("status") == "error") {
									SQ.alert('验证码输入错误');
									//$tempdata.hasClass("no-focus") || $tempdata.focus();
									return false;
								}
							}
	            			if( !$tempdata.val() ) {
	            				SQ.alert($tempdata.data('message'));
								//$tempdata.hasClass("no-focus") || $tempdata.focus();
        						return false;
	            			}
							data[tempdata.name] = tempdata.value;
						}
						//判断是否上传图片
						// if ( $('#service-form-edit .pr').length <= 0 ) { SQ.alert('请上传身份证扫描件'); return false; }
						//发现时间
						data['find_time'] = $("#find_time")[0].value;
						//判断验证码是否可传
						delete data.select_game;
						$this.addClass( "pending" );
						ajaxFn( $.extend( true, {}, _this.aj, {
	                        url: API.addplugin,
	                        data: data,
	                        successCall: function( res ) {
								$this.removeClass( "pending" );
	                            if ( !res ) return;
	                            $('#aucode').val('').siblings('.codeimg').attr('src', "http://kf.37.com/index.php?c=index&a=aucode&t=1462520170").siblings('.field-right-message').hide();
	                            if ( res.code == 1 ) {
	                                $('#service-form-edit').hide();
	                                $('#service-form-result').show();
									$(".service-other").show();
	                                $('body, html').animate({ scrollTop: '0'},200);
	                            } else {
									modulesUtil.varCodeRefresh();
	                                SQ.alert( res.msg );
	                            }
	                        },
	                        failCall: function() {
								$this.removeClass( "pending" );
	                            SQ.alert('验证失败，请稍后再试');
	                        }
	                    } ) );
					});
                ////验证验证码是否输入正确
                //_this.$saveCode
                //	.on( "keyup", function() {
	             //       var $this = $( this ),
	             //       	$msgDom = $(this).siblings('.field-error-message'),
	             //       	$rightDom = $(this).siblings('.field-right-message'),
	             //           msgText = $this.data( "message" );
	             //       if ( $this.val().length !== 4 ) {
	             //           // $this.data( "status", "error" );
	             //           SQ.log(msgText);
	             //           $msgDom.text( msgText ).show();
	             //           return;
	             //       }
	             //       // $this.data( "status", "padding" );
	             //       ajaxFn( $.extend( true, {}, _this.aj, {
	             //           url: API.checkcode,
	             //           data: {
	             //               ajax: 1,
	             //               safe_code: $this.val()
	             //           },
	             //           successCall: function( res ) {
	             //               if ( !res ) return;
                //
	             //               if ( res.code !== 1 ) {
	             //                   // $this.data( "status", "error" );
	             //                   $msgDom.text( res.msg ).show();
	             //               } else {
	             //                   $msgDom.text('').hide();
	             //                   $rightDom.text( res.msg ).show();
	             //               }
	             //           },
	             //           failCall: function() {
	             //               $msgDom.text( "安全码验证失败，请稍后再试" );
	             //           }
	             //       } ) );
               	// 	} );

			}
			// commitForm: function(aucode, game, server, avatar, plugin_type, description, find_time) {
			// 	var url = 'http://kf.37.com/index.php?c=report_plugin&a=actAdd';
			// 	$.ajax({
			// 		url: url,
			// 		type: get,
			// 		dataType: jsonp,
			// 		data: {
			// 			aucode:,
			// 			game: ,
			// 			server: ,
			// 			avatar: ,
			// 			plugin_type: ,
			// 			description: ,
			// 			find_time:
			// 		}
			// 	}).done(function(res) {
			// 		if (res.code == 1) {
			// 			$('#report-first').hide();
			// 			$('#report-second').show();
			// 			$('body, html').animate({ scrollTop: '0px'},200);
			// 		}else {
			// 			SQ.alert(res.msg);
			// 		}
			// 	}).fail(function() {
			// 		SQ.alert('表单填写错误');
			// 	});
					
			// }
		};
		return {
	        init:function(){
	            main.init();
	        }
		};
});